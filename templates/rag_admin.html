{% extends "base.html" %}

{% block title %}RAG System - SolarMind{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Header -->
        <div class="col-12">
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header border-warning">
                    <h3 class="text-warning mb-0">
                        üß† RAG System - Base de Conhecimento
                    </h3>
                    <p class="text-light mb-0">
                        Gerenciar sistema de conhecimento contextual para IA
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Status Card -->
        <div class="col-md-4">
            <div class="card bg-dark border-success mb-4">
                <div class="card-header border-success">
                    <h5 class="text-success mb-0">üìä Status do Sistema</h5>
                </div>
                <div class="card-body">
                    <div id="rag-status">
                        <div class="text-center">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-light mt-2">Verificando status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Card -->
        <div class="col-md-8">
            <div class="card bg-dark border-warning mb-4">
                <div class="card-header border-warning">
                    <h5 class="text-warning mb-0">‚ö° A√ß√µes do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button id="rebuild-btn" class="btn btn-warning w-100 mb-3">
                                üîÑ Reconstruir Base
                            </button>
                            <small class="text-muted">
                                Reconstr√≥i toda a base de conhecimento analisando o c√≥digo atual
                            </small>
                        </div>
                        <div class="col-md-6">
                            <button id="test-search-btn" class="btn btn-info w-100 mb-3">
                                üîç Testar Busca
                            </button>
                            <small class="text-muted">
                                Testa a busca de contexto na base de conhecimento
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Search Testing -->
        <div class="col-md-6">
            <div class="card bg-dark border-info mb-4">
                <div class="card-header border-info">
                    <h5 class="text-info mb-0">üîç Teste de Busca RAG</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="search-query" class="form-label text-light">Pergunta de Teste:</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" 
                               id="search-query" placeholder="Ex: como configurar autopilot">
                    </div>
                    <button id="search-btn" class="btn btn-info">Buscar Contexto</button>
                    
                    <div id="search-results" class="mt-3" style="display: none;">
                        <h6 class="text-info">Resultados:</h6>
                        <div id="search-content" class="bg-secondary p-3 rounded">
                            <!-- Resultados aparecer√£o aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Knowledge Stats -->
        <div class="col-md-6">
            <div class="card bg-dark border-success mb-4">
                <div class="card-header border-success">
                    <h5 class="text-success mb-0">üìö Estat√≠sticas da Base</h5>
                </div>
                <div class="card-body">
                    <div id="knowledge-stats">
                        <div class="text-center text-muted">
                            Carregue o status primeiro...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Card -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header border-secondary">
                    <h5 class="text-secondary mb-0">üìã Logs de Atividade</h5>
                </div>
                <div class="card-body">
                    <div id="activity-logs" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-muted">Logs aparecer√£o aqui...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class RAGAdmin {
    constructor() {
        this.initEventListeners();
        this.loadStatus();
    }

    initEventListeners() {
        document.getElementById('rebuild-btn').addEventListener('click', () => this.rebuildKnowledge());
        document.getElementById('test-search-btn').addEventListener('click', () => this.loadStatus());
        document.getElementById('search-btn').addEventListener('click', () => this.searchKnowledge());
        
        // Enter key no search
        document.getElementById('search-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.searchKnowledge();
        });
    }

    async loadStatus() {
        this.log('Carregando status do RAG system...');
        
        try {
            const response = await fetch('/api/rag/status');
            const data = await response.json();
            
            if (data.status === 'sucesso') {
                this.renderStatus(data);
                this.renderStats(data.stats);
                this.log('‚úÖ Status carregado com sucesso');
            } else {
                this.showError('Erro ao carregar status: ' + (data.message || 'Erro desconhecido'));
            }
        } catch (error) {
            this.showError('Erro de conex√£o: ' + error.message);
        }
    }

    renderStatus(data) {
        const statusDiv = document.getElementById('rag-status');
        const isEnabled = data.rag_enabled;
        const hasKnowledge = data.stats?.knowledge_base_exists;
        
        statusDiv.innerHTML = `
            <div class="mb-3">
                <span class="badge ${isEnabled ? 'bg-success' : 'bg-danger'} mb-2 w-100">
                    ${isEnabled ? '‚úÖ RAG Habilitado' : '‚ùå RAG Desabilitado'}
                </span>
            </div>
            <div class="mb-3">
                <span class="badge ${hasKnowledge ? 'bg-success' : 'bg-warning'} mb-2 w-100">
                    ${hasKnowledge ? 'üìö Base Existe' : '‚ö†Ô∏è Base N√£o Criada'}
                </span>
            </div>
            ${data.stats?.generated_at ? `
                <div class="text-light">
                    <small>
                        <strong>Gerada em:</strong><br>
                        ${new Date(data.stats.generated_at).toLocaleString('pt-BR')}
                    </small>
                </div>
            ` : ''}
            ${data.stats?.version ? `
                <div class="text-light mt-2">
                    <small><strong>Vers√£o:</strong> ${data.stats.version}</small>
                </div>
            ` : ''}
        `;
    }

    renderStats(stats) {
        if (!stats || !stats.categories) return;
        
        const statsDiv = document.getElementById('knowledge-stats');
        const categories = stats.categories;
        
        let html = '';
        for (const [category, count] of Object.entries(categories)) {
            const displayName = this.getCategoryDisplayName(category);
            html += `
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-light">${displayName}:</span>
                    <span class="badge bg-info">${count}</span>
                </div>
            `;
        }
        
        statsDiv.innerHTML = html || '<p class="text-muted">Sem dados dispon√≠veis</p>';
    }

    getCategoryDisplayName(category) {
        const names = {
            'features': 'üîß Features',
            'api_endpoints': 'üåê Endpoints',
            'models': 'üóÉÔ∏è Modelos',
            'services': '‚öôÔ∏è Servi√ßos',
            'templates': 'üé® Templates',
            'documentation': 'üìñ Documenta√ß√£o'
        };
        return names[category] || category;
    }

    async rebuildKnowledge() {
        const btn = document.getElementById('rebuild-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = 'üîÑ Reconstruindo...';
        btn.disabled = true;
        
        this.log('üîÑ Iniciando reconstru√ß√£o da base de conhecimento...');
        
        try {
            const response = await fetch('/api/rag/rebuild', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'sucesso') {
                this.log('‚úÖ Base de conhecimento reconstru√≠da com sucesso!');
                this.log(`üìö Categorias processadas: ${data.categories?.join(', ')}`);
                
                // Recarrega status
                setTimeout(() => this.loadStatus(), 1000);
                
                this.showSuccess('Base de conhecimento reconstru√≠da!');
            } else {
                this.showError('Erro na reconstru√ß√£o: ' + (data.message || 'Erro desconhecido'));
            }
        } catch (error) {
            this.showError('Erro de conex√£o: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async searchKnowledge() {
        const query = document.getElementById('search-query').value.trim();
        
        if (!query) {
            alert('Digite uma pergunta para testar a busca');
            return;
        }
        
        const btn = document.getElementById('search-btn');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = 'üîç Buscando...';
        btn.disabled = true;
        
        this.log(`üîç Testando busca: "${query}"`);
        
        try {
            const response = await fetch('/api/rag/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: query,
                    max_items: 3
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'sucesso') {
                this.renderSearchResults(data);
                this.log(`‚úÖ Busca conclu√≠da: ${data.results_count} resultados`);
            } else {
                this.showError('Erro na busca: ' + (data.message || 'Erro desconhecido'));
            }
        } catch (error) {
            this.showError('Erro de conex√£o: ' + error.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    renderSearchResults(data) {
        const resultsDiv = document.getElementById('search-results');
        const contentDiv = document.getElementById('search-content');
        
        if (data.results_count === 0) {
            contentDiv.innerHTML = '<p class="text-warning">Nenhum contexto relevante encontrado.</p>';
        } else {
            let html = `<p class="text-info mb-3">Encontrados ${data.results_count} contextos relevantes:</p>`;
            
            data.context.forEach((ctx, index) => {
                html += `
                    <div class="border border-secondary rounded p-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong class="text-warning">${index + 1}. ${ctx.category}</strong>
                            <span class="badge bg-success">${(ctx.relevance * 100).toFixed(0)}%</span>
                        </div>
                        <div class="text-light mt-1">
                            ${this.formatContextContent(ctx.content)}
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
        }
        
        resultsDiv.style.display = 'block';
    }

    formatContextContent(content) {
        if (content.route) {
            return `<strong>Rota:</strong> ${content.route}<br><strong>Descri√ß√£o:</strong> ${content.description || 'N/A'}`;
        } else if (content.path) {
            return `<strong>Endpoint:</strong> ${content.path}<br><strong>Categoria:</strong> ${content.category || 'N/A'}`;
        } else if (content.name) {
            return `<strong>Nome:</strong> ${content.name}<br><strong>Prop√≥sito:</strong> ${content.purpose || content.description || 'N/A'}`;
        }
        return JSON.stringify(content, null, 2);
    }

    log(message) {
        const logsDiv = document.getElementById('activity-logs');
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        
        const logEntry = document.createElement('div');
        logEntry.className = 'text-light mb-1';
        logEntry.innerHTML = `<small>[${timestamp}]</small> ${message}`;
        
        logsDiv.insertBefore(logEntry, logsDiv.firstChild);
        
        // Limita a 50 logs
        while (logsDiv.children.length > 50) {
            logsDiv.removeChild(logsDiv.lastChild);
        }
    }

    showSuccess(message) {
        // Implementa√ß√£o simples - pode ser melhorada com toast
        this.log(`‚úÖ ${message}`);
    }

    showError(message) {
        this.log(`‚ùå ${message}`);
        console.error('RAG Admin Error:', message);
    }
}

// Inicializa quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    new RAGAdmin();
});
</script>
{% endblock %}
