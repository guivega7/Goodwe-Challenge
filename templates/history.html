{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Histórico | SolarMind{% endblock %}

{% block extra_head %}
<style>
  .glass { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; }
  .section-title { color:#f8fafc; font-size:1.6rem; font-weight:600; margin-bottom:1rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="section-title mb-0">Histórico de Geração</h1>
    <a href="{{ url_for('dash.dashboard') }}" class="btn btn-outline-light">
      <i class="fa-solid fa-arrow-left me-2"></i>Voltar ao Dashboard
    </a>
  </div>

  <!-- Cards acumulados -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="glass p-4 text-center">
        <i class="fa-solid fa-solar-panel fa-3x mb-3" style="color:#FE5800;"></i>
        <h6 class="text-light mb-1">Total Gerado</h6>
        <h3 class="fw-bold" style="color:#FE5800;">{{ '%.1f'|format(acumulados.total_gerado) }}</h3>
        <small class="text-light">kWh acumulados</small>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="glass p-4 text-center">
        <i class="fa-solid fa-piggy-bank fa-3x mb-3" style="color:#28a745;"></i>
        <h6 class="text-light mb-1">Economia Total</h6>
        <h3 class="fw-bold" style="color:#28a745;">R$ {{ '%.2f'|format(acumulados.economia_total) }}</h3>
        <small class="text-light">economizados</small>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="glass p-4 text-center">
        <i class="fa-solid fa-leaf fa-3x mb-3" style="color:#20c997;"></i>
        <h6 class="text-light mb-1">CO₂ Evitado</h6>
        <h3 class="fw-bold" style="color:#20c997;">{{ '%.1f'|format(acumulados.co2_evitado) }}</h3>
        <small class="text-light">kg de CO₂</small>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="glass p-4 text-center">
        <i class="fa-solid fa-calendar-days fa-3x mb-3" style="color:#17a2b8;"></i>
        <h6 class="text-light mb-1">Dias Ativos</h6>
        <h3 class="fw-bold" style="color:#17a2b8;">{{ acumulados.dias_ativos }}</h3>
        <small class="text-light">dias gerando</small>
      </div>
    </div>
  </div>

  <!-- Histórico 7 dias -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="glass p-4">
        <div class="d-flex align-items-center mb-4">
          <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
          <h5 class="fw-semibold mb-0" style="color:#FE5800;">Histórico dos Últimos 7 Dias</h5>
        </div>
        <div style="position: relative; height: 360px;">
          <canvas id="graficoHistorico"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensal e Anual -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="glass p-4">
        <div class="d-flex align-items-center mb-3">
          <i class="fa-solid fa-chart-column fa-2x me-3" style="color:#FE5800;"></i>
          <h5 class="fw-semibold mb-0" style="color:#FE5800;">Geração Mensal</h5>
        </div>
        <div style="position: relative; height: 300px;">
          <canvas id="graficoMensal"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="glass p-4">
        <div class="d-flex align-items-center mb-3">
          <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
          <h5 class="fw-semibold mb-0" style="color:#FE5800;">Comparativo Anual</h5>
        </div>
        <div style="position: relative; height: 300px;">
          <canvas id="graficoAnual"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const historico = JSON.parse(String.raw`{{ historico_7dias|tojson|safe }}`);
  const monthly = JSON.parse(String.raw`{{ monthly_data|tojson|safe }}`);
  const annual = JSON.parse(String.raw`{{ annual_data|tojson|safe }}`);

  function fmt(n){ if(n===undefined||n===null||isNaN(n)) return 0; return Math.round(n*100)/100; }

  // Histórico 7 dias
  const labelsH = historico.map(h => h.data);
  const energiaH = historico.map(h => fmt(h.energia));
  new Chart(document.getElementById('graficoHistorico'), {
    type:'line',
    data:{ labels: labelsH, datasets:[
      { label:'Energia Gerada (kWh)', data: energiaH, borderColor:'#FE5800', backgroundColor:'rgba(254,88,0,0.15)', tension:0.35, fill:true }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#fff'} } }, scales:{ y:{ beginAtZero:true, ticks:{color:'#fff'} }, x:{ ticks:{color:'#fff'} } } }
  });

  // Mensal
  new Chart(document.getElementById('graficoMensal'), {
    type:'bar',
    data:{ labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets:[{ label:'Geração Mensal (kWh)', data: monthly, backgroundColor:'#FE5800', borderRadius:8 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#fff'} } }, scales:{ y:{ beginAtZero:true, ticks:{color:'#fff'} }, x:{ ticks:{color:'#fff'} } } }
  });

  // Anual
  const currentYear = new Date().getFullYear();
  const labelsA = [currentYear-4, currentYear-3, currentYear-2, currentYear-1, currentYear];
  new Chart(document.getElementById('graficoAnual'), {
    type:'line',
    data:{ labels: labelsA, datasets:[{ label:'Geração Anual (kWh)', data: annual, borderColor:'#28a745', backgroundColor:'rgba(40,167,69,0.15)', tension:0.35, fill:true }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#fff'} } }, scales:{ y:{ beginAtZero:true, ticks:{color:'#fff'} }, x:{ ticks:{color:'#fff'} } } }
  });
</script>
{% endblock %}
