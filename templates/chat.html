{% extends "base.html" %}
{% set active_page = 'chat' %}
{% block title %}Chat IA | SolarMind{% endblock %}

{% block content %}
<div class="container-fluid px-4">
<div class="d-flex align-items-center mb-3">
  <i class="fa-solid fa-robot fa-2x me-2" style="color:#FE5800;"></i>
  <h3 class="mb-0">Chat com IA Solar</h3>
  <span class="ms-2 text-light">ASSISTENTE INTELIGENTE</span>
  <div class="ms-auto">
    <button id="clearChatBtn" class="btn btn-outline-light btn-sm">Limpar Histórico</button>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <!-- Área de mensagens -->
    <div class="glass p-4 mb-4">
      <div id="chatMessages" class="bg-dark rounded p-4 mb-3" style="height: 400px; overflow-y: auto;">
        <div class="text-center text-light opacity-75">
          <i class="fa-solid fa-comments fa-2x mb-2"></i>
          <p>Olá! Sou seu assistente de energia solar. Pergunte sobre o SolarMind, sistemas solares ou qualquer dúvida técnica!</p>
        </div>
      </div>
      
      <!-- Formulário de envio -->
      <div class="input-group">
        <input type="text" id="messageInput" class="form-control form-control-lg" 
               placeholder="Digite sua pergunta sobre energia solar..." maxlength="500">
        <button id="sendBtn" class="btn btn-warning" type="button">
          <i class="fa-solid fa-paper-plane"></i> Enviar
        </button>
      </div>
      
      <!-- Status -->
      <div class="mt-3">
        <small id="chatStatus" class="text-light opacity-75"></small>
      </div>
    </div>
  </div>
</div>

<!-- Card de exemplos -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card bg-dark border-secondary">
      <div class="card-header">
        <h6 class="mb-0"><i class="fa-solid fa-lightbulb me-2"></i>Exemplos de perguntas</h6>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-6">
            <button class="btn btn-outline-light btn-sm w-100 example-btn" 
                    data-message="Como posso economizar mais energia com meu sistema solar?">
              💡 Como economizar mais energia?
            </button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-outline-light btn-sm w-100 example-btn" 
                    data-message="O que é o Energy Autopilot do SolarMind?">
              🤖 O que é o Energy Autopilot?
            </button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-outline-light btn-sm w-100 example-btn" 
                    data-message="Minha bateria está sempre baixa, o que fazer?">
              🔋 Bateria sempre baixa
            </button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-outline-light btn-sm w-100 example-btn" 
                    data-message="Como funciona a integração com a Alexa?">
              🔊 Integração com Alexa
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
class ChatUI {
  constructor() {
    this.messagesContainer = document.getElementById('chatMessages');
    this.messageInput = document.getElementById('messageInput');
    this.sendBtn = document.getElementById('sendBtn');
    this.clearBtn = document.getElementById('clearChatBtn');
    this.status = document.getElementById('chatStatus');
    
    this.init();
  }
  
  init() {
    // Event listeners
    this.sendBtn.addEventListener('click', () => this.sendMessage());
    this.messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.sendMessage();
    });
    this.clearBtn.addEventListener('click', () => this.clearChat());
    
    // Botões de exemplo
    document.querySelectorAll('.example-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        this.messageInput.value = btn.dataset.message;
        this.sendMessage();
      });
    });
    
    // Carregar histórico
    this.loadMessages();
  }
  
  async loadMessages() {
    try {
      const response = await fetch('/api/chat/messages');
      const data = await response.json();
      
      if (data.status === 'sucesso') {
        this.messagesContainer.innerHTML = '';
        data.messages.forEach(msg => this.addMessage(msg));
        this.scrollToBottom();
      }
    } catch (e) {
      console.error('Erro ao carregar mensagens:', e);
    }
  }
  
  addMessage(message) {
    const isUser = message.role === 'user';
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}`;
    
    const bubble = document.createElement('div');
    bubble.className = `p-3 rounded ${isUser ? 'bg-warning text-white' : 'bg-secondary text-white'}`;
    bubble.style.maxWidth = '80%';
    if (isUser) {
      bubble.style.background = 'linear-gradient(45deg, #ffc107, #ff8c00)';
    }
    
    const icon = isUser ? '👤' : '🤖';
    const time = new Date(message.timestamp).toLocaleTimeString('pt-BR', {
      hour: '2-digit', minute: '2-digit'
    });
    
    bubble.innerHTML = `
      <div class="fw-bold mb-1">${icon} ${isUser ? 'Você' : 'IA Solar'}</div>
      <div>${this.formatMessage(message.content)}</div>
      <small class="opacity-75">${time}</small>
    `;
    
    messageDiv.appendChild(bubble);
    this.messagesContainer.appendChild(messageDiv);
  }
  
  formatMessage(content) {
    // Quebras de linha e formatação básica
    return content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  }
  
  async sendMessage() {
    const message = this.messageInput.value.trim();
    if (!message) return;
    
    // Desabilitar interface
    this.sendBtn.disabled = true;
    this.messageInput.disabled = true;
    this.status.textContent = 'Enviando...';
    
    try {
      const response = await fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      
      const data = await response.json();
      
      if (data.status === 'sucesso') {
        this.addMessage(data.user_message);
        this.addMessage(data.ai_response);
        this.scrollToBottom();
        this.messageInput.value = '';
        this.status.textContent = '';
      } else {
        this.status.textContent = `Erro: ${data.mensagem}`;
      }
    } catch (e) {
      this.status.textContent = 'Erro de conexão';
      console.error('Erro no chat:', e);
    } finally {
      // Reabilitar interface
      this.sendBtn.disabled = false;
      this.messageInput.disabled = false;
    }
  }
  
  async clearChat() {
    if (!confirm('Deseja realmente limpar todo o histórico?')) return;
    
    try {
      const response = await fetch('/api/chat/clear', { method: 'POST' });
      const data = await response.json();
      
      if (data.status === 'sucesso') {
        this.messagesContainer.innerHTML = `
          <div class="text-center text-light opacity-75">
            <i class="fa-solid fa-comments fa-2x mb-2"></i>
            <p>Histórico limpo! Faça sua primeira pergunta.</p>
          </div>
        `;
        this.status.textContent = 'Histórico limpo';
        setTimeout(() => this.status.textContent = '', 3000);
      }
    } catch (e) {
      this.status.textContent = 'Erro ao limpar histórico';
      console.error('Erro:', e);
    }
  }
  
  scrollToBottom() {
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
  new ChatUI();
});
</script>
</div> <!-- fecha container-fluid -->
{% endblock %}
