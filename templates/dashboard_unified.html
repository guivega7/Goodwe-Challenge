{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard | SolarMind{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="text-center mb-5">
  <i class="fa-solid fa-chart-line fa-4x mb-3" style="color:#FE5800;"></i>
  <h2 class="fw-bold" style="color:#FE5800;">Dashboard Completo</h2>
  <p class="lead text-light">Monitore performance, estatÃ­sticas e insights do seu sistema solar</p>
</div>

<!-- Controles de Fonte de Dados -->
<div class="glass p-4 mb-4">
  <div class="d-flex align-items-center mb-3">
    <i class="fa-solid fa-cogs fa-2x me-3" style="color:#FE5800;"></i>
    <h5 class="fw-semibold mb-0" style="color:#FE5800;">ConfiguraÃ§Ã£o de Dados</h5>
  </div>
  
  <form method="GET" action="/dashboard" class="row g-3">
    <div class="col-md-4">
      <label class="form-label">
        <i class="fa-solid fa-database me-2"></i>Fonte de Dados:
      </label>
      <select name="fonte" class="form-select form-select-lg" onchange="toggleSnInput()">
        <option value="mock" {% if request.args.get('fonte', 'mock') == 'mock' %}selected{% endif %}>
          ðŸ”µ Dados Simulados (Mock)
        </option>
        <option value="api" {% if request.args.get('fonte') == 'api' %}selected{% endif %}>
          ðŸ”— GoodWe SEMS API
        </option>
      </select>
    </div>
    
    <div class="col-md-6" id="snContainer" style="{% if request.args.get('fonte', 'mock') == 'mock' %}display:none;{% endif %}">
      <label class="form-label">
        <i class="fa-solid fa-microchip me-2"></i>NÃºmero de SÃ©rie do Inversor:
      </label>
      <input type="text" name="sn" class="form-control form-control-lg" 
             placeholder="Ex: 75000ESN333WV001" 
             value="{{ request.args.get('sn', '') }}">
    </div>
    
    <div class="col-md-2">
      <label class="form-label">&nbsp;</label>
      <button type="submit" class="btn btn-gw btn-lg d-block w-100">
        <i class="fa-solid fa-sync-alt me-2"></i>Atualizar
      </button>
    </div>
  </form>
</div>

<!-- KPIs Principais em Cards -->
<div class="row g-4 mb-5">
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-solar-panel fa-3x mb-3" style="color:#ffc107;"></i>
      <h6 class="text-light mb-1">Energia Hoje</h6>
      <h3 class="fw-bold" style="color:#ffc107;">{{ relatorio.energia_hoje or '22.4' }}</h3>
      <small class="text-light">kWh gerados</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-battery-three-quarters fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">SOC Bateria</h6>
      <h3 class="fw-bold" style="color:#28a745;">{{ relatorio.soc_bateria or '87' }}</h3>
      <small class="text-light">% carregada</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-money-bill-wave fa-3x mb-3" style="color:#20c997;"></i>
      <h6 class="text-light mb-1">Economia Hoje</h6>
      <h3 class="fw-bold" style="color:#20c997;">R$ {{ relatorio.economia_hoje or '18.50' }}</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-{% if relatorio.status == 'online' %}wifi{% else %}wifi-slash{% endif %} fa-3x mb-3" 
         style="color:{% if relatorio.status == 'online' %}#28a745{% else %}#6c757d{% endif %};"></i>
      <h6 class="text-light mb-1">Status Sistema</h6>
      <h3 class="fw-bold" style="color:{% if relatorio.status == 'online' %}#28a745{% else %}#6c757d{% endif %};">
        {{ relatorio.status|title or 'Online' }}
      </h3>
      <small class="text-light">{{ relatorio.updated_at or 'Agora' }}</small>
    </div>
  </div>
</div>

<!-- KPIs HistÃ³ricos -->
<div class="row g-4 mb-5">
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-chart-column fa-3x mb-3" style="color:#FE5800;"></i>
      <h6 class="text-light mb-1">Total Gerado</h6>
      <h3 class="fw-bold" style="color:#FE5800;">3,245</h3>
      <small class="text-light">kWh acumulados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-piggy-bank fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">Economia Total</h6>
      <h3 class="fw-bold" style="color:#28a745;">R$ 2,434</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-leaf fa-3x mb-3" style="color:#20c997;"></i>
      <h6 class="text-light mb-1">COâ‚‚ Evitado</h6>
      <h3 class="fw-bold" style="color:#20c997;">1,623</h3>
      <small class="text-light">kg de COâ‚‚</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-calendar-days fa-3x mb-3" style="color:#17a2b8;"></i>
      <h6 class="text-light mb-1">Dias Ativos</h6>
      <h3 class="fw-bold" style="color:#17a2b8;">287</h3>
      <small class="text-light">dias gerando</small>
    </div>
  </div>
</div>

<!-- Insights IA com Cores Fortes -->
<div class="row mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-brain fa-2x me-3" style="color:#FE5800;"></i>
          <h5 class="fw-semibold mb-0" style="color:#FE5800;">Insights Inteligentes</h5>
        </div>
        <button id="generateInsightsBtn" class="btn btn-warning">
          <i class="fa-solid fa-sparkles me-2"></i>Gerar Insights
        </button>
      </div>
      
      <div id="insightsContent">
        <!-- Insights com cores MUITO mais legÃ­veis -->
        <div class="alert mb-3" style="background: #28a745; border: 3px solid #1e7e34; color: #fff; font-weight: 500;">
          <i class="fas fa-sun text-warning me-2" style="font-size: 1.3em;"></i>
          <strong style="color: #fff; font-size: 1.1em;">ðŸŒž EXCELENTE PERFORMANCE!</strong> <span style="color: #fff;">VocÃª gerou 25.3 kWh hoje e consumiu 18.7 kWh. 
          Sua energia solar cobriu <strong style="color: #ffeb3b; font-size: 1.1em;">135%</strong> do consumo! Continue aproveitando esses dias ensolarados.</span>
        </div>
        
        <div class="alert mb-3" style="background: #17a2b8; border: 3px solid #117a8b; color: #fff; font-weight: 500;">
          <i class="fas fa-battery-full text-success me-2" style="font-size: 1.3em;"></i>
          <strong style="color: #fff; font-size: 1.1em;">ðŸ”‹ BATERIA PERFEITA!</strong> <span style="color: #fff;">87% de carga - ideal para o horÃ¡rio de ponta! 
          Use energia Ã  vontade atÃ© 18h, depois economize para passar a noite <strong style="color: #4caf50;">sem custo extra</strong>.</span>
        </div>
        
        <div class="alert mb-3" style="background: #ffc107; border: 3px solid #e0a800; color: #000; font-weight: 500;">
          <i class="fas fa-leaf text-success me-2" style="font-size: 1.3em;"></i>
          <strong style="color: #000; font-size: 1.1em;">ðŸŒ± IMPACTO AMBIENTAL:</strong> <span style="color: #000;">Evitou <strong style="color: #d32f2f;">12.6kg de CO2</strong> hoje! 
          Equivale a 6.3 km nÃ£o rodados de carro. <strong style="color: #388e3c;">Continue fazendo a diferenÃ§a!</strong></span>
        </div>
        
        <div class="alert mb-0" style="background: #FE5800; border: 3px solid #dc4a00; color: #fff; font-weight: 500;">
          <i class="fas fa-lightbulb text-warning me-2" style="font-size: 1.3em;"></i>
          <strong style="color: #fff; font-size: 1.1em;">ðŸ’¡ DICA VALIOSA:</strong> <span style="color: #fff;">
          Programe sua mÃ¡quina de lavar para 14h - vocÃª tem energia solar sobrando e vai economizar <strong style="color: #4caf50; font-size: 1.1em;">R$ 2,50!</strong></span>
        </div>
        
        <div class="text-muted mt-3 small" style="color: #ccc !important;">
          <i class="fas fa-info-circle me-1"></i>
          Insights atualizados automaticamente. Clique em "Gerar Insights" para anÃ¡lises personalizadas.
        </div>
      </div>
      
      <div id="insightsLoading" class="text-center d-none py-3">
        <div class="spinner-border spinner-border-sm text-warning me-2" role="status"></div>
        <span class="text-warning">Analisando dados com IA...</span>
      </div>
    </div>
  </div>
</div>

<!-- GrÃ¡ficos Combinados -->
<div class="row g-4 mb-4">
  <!-- GrÃ¡fico HistÃ³rico 7 Dias -->
  <div class="col-lg-8">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">HistÃ³rico Ãšltimos 7 Dias</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoHistorico"></canvas>
      </div>
    </div>
  </div>

  <!-- GrÃ¡fico de DistribuiÃ§Ã£o de Energia -->
  <div class="col-lg-4">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-pie fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">DistribuiÃ§Ã£o Energia</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoDistribuicao"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- GrÃ¡ficos Mensais e Anuais -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-column fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Performance Mensal</h5>
      </div>
      <div style="position: relative; height: 350px;">
        <canvas id="graficoMensal"></canvas>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-line fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">TendÃªncia Anual</h5>
      </div>
      <div style="position: relative; height: 350px;">
        <canvas id="graficoAnual"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // FunÃ§Ã£o para mostrar/esconder campo SN
  function toggleSnInput() {
    const fonte = document.querySelector('select[name="fonte"]').value;
    const snContainer = document.getElementById('snContainer');
    if (fonte === 'api') {
      snContainer.style.display = 'block';
    } else {
      snContainer.style.display = 'none';
    }
  }

  // ConfiguraÃ§Ã£o comum dos grÃ¡ficos
  const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        labels: {
          color: '#ffffff',
          font: { size: 12 }
        }
      }
    },
    scales: {
      x: {
        ticks: { color: '#ffffff' },
        grid: { color: 'rgba(255, 255, 255, 0.1)' }
      },
      y: {
        ticks: { 
          color: '#ffffff',
          callback: function(value) {
            return value + ' kWh';
          }
        },
        grid: { color: 'rgba(255, 255, 255, 0.1)' }
      }
    }
  };

  // GrÃ¡fico de histÃ³rico melhorado (7 dias)
  const ctx = document.getElementById('graficoHistorico').getContext('2d');
  const graficoHistorico = new Chart(ctx, {
    type: 'line',
    data: {
      labels: {{ labels_historico|tojson|safe }},
      datasets: [{
        label: 'Energia Gerada',
        data: {{ dados_historico|tojson|safe }},
        borderColor: '#FE5800',
        backgroundColor: 'rgba(254, 88, 0, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#FE5800',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }, {
        label: 'Energia Consumida',
        data: {{ dados_consumo|tojson|safe }},
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#17a2b8',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 6
      }]
    },
    options: {
      ...chartConfig,
      plugins: {
        ...chartConfig.plugins,
        title: {
          display: true,
          text: 'GeraÃ§Ã£o vs Consumo (Ãšltimos 7 Dias)',
          color: '#ffffff',
          font: { size: 16, weight: 'bold' }
        }
      }
    }
  });

  // GrÃ¡fico de DistribuiÃ§Ã£o de Energia
  const ctxDistribuicao = document.getElementById('graficoDistribuicao').getContext('2d');
  const graficoDistribuicao = new Chart(ctxDistribuicao, {
    type: 'doughnut',
    data: {
      labels: ['Consumido', 'Armazenado', 'Injetado'],
      datasets: [{
        data: [60, 25, 15],
        backgroundColor: ['#FE5800', '#28a745', '#17a2b8'],
        borderColor: ['#fff', '#fff', '#fff'],
        borderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#ffffff',
            font: { size: 12 }
          }
        },
        title: {
          display: true,
          text: 'Uso da Energia Gerada',
          color: '#ffffff',
          font: { size: 14, weight: 'bold' }
        }
      }
    }
  });

  // GrÃ¡fico Mensal
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  const graficoMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
      datasets: [{
        label: 'Energia Gerada (kWh)',
        data: [450, 520, 580, 420, 380, 320, 340, 400, 480, 550, 600, 490],
        backgroundColor: 'rgba(254, 88, 0, 0.8)',
        borderColor: '#FE5800',
        borderWidth: 2
      }]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: {
          ...chartConfig.scales.y,
          ticks: {
            ...chartConfig.scales.y.ticks,
            callback: function(value) {
              return value + ' kWh';
            }
          }
        }
      }
    }
  });

  // GrÃ¡fico Anual
  const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
  const graficoAnual = new Chart(ctxAnual, {
    type: 'line',
    data: {
      labels: ['2021', '2022', '2023', '2024', '2025'],
      datasets: [{
        label: 'Total Anual (kWh)',
        data: [4200, 5100, 5800, 6200, 3245],
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        borderWidth: 4,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#28a745',
        pointBorderColor: '#fff',
        pointBorderWidth: 3,
        pointRadius: 8
      }]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: {
          ...chartConfig.scales.y,
          ticks: {
            ...chartConfig.scales.y.ticks,
            callback: function(value) {
              return value + ' kWh';
            }
          }
        }
      }
    }
  });

  // Insights IA
  document.getElementById('generateInsightsBtn').addEventListener('click', function() {
    const button = this;
    const content = document.getElementById('insightsContent');
    const loading = document.getElementById('insightsLoading');
    
    button.disabled = true;
    content.style.display = 'none';
    loading.classList.remove('d-none');
    
    fetch('/api/insights', { method: 'POST' })
      .then(response => response.json())
      .then(data => {
        if (data.insights && data.insights.length > 0) {
          let insightsHtml = '';
          data.insights.forEach((insight, index) => {
            const colors = [
              { bg: '#28a745', border: '#1e7e34' }, // Verde
              { bg: '#007bff', border: '#0056b3' }, // Azul
              { bg: '#ffc107', border: '#e0a800' }  // Amarelo
            ];
            const color = colors[index % colors.length];
            
            insightsHtml += `
              <div class="alert alert-success mb-2" style="background: ${color.bg}; border: 3px solid ${color.border}; color: #fff; font-weight: 500;">
                <i class="fas fa-lightbulb me-2"></i>
                <strong style="color: #fff;">${insight}</strong>
              </div>
            `;
          });
          
          // Adicionar fonte se disponÃ­vel
          if (data.source) {
            insightsHtml += `
              <div class="text-center mt-2">
                <small class="text-light">
                  <i class="fas fa-robot me-1"></i>
                  Gerado por ${data.source === 'gemini_ai' ? 'InteligÃªncia Artificial' : 'Sistema SolarMind'}
                </small>
              </div>
            `;
          }
          
          content.innerHTML = insightsHtml;
        } else {
          content.innerHTML = `
            <div class="alert alert-warning" style="background: #ffc107; border: 3px solid #e0a800; color: #000; font-weight: 500;">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong style="color: #000;">Nenhum insight disponÃ­vel no momento.</strong>
            </div>
          `;
        }
      })
      .catch(() => {
        content.innerHTML = `
          <div class="alert alert-warning" style="background: #ffc107; border: 3px solid #e0a800; color: #000; font-weight: 500;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong style="color: #000;">ServiÃ§o temporariamente indisponÃ­vel. Tente novamente em alguns minutos.</strong>
          </div>
        `;
      })
      .finally(() => {
        button.disabled = false;
        loading.classList.add('d-none');
        content.style.display = 'block';
      });
  });

  // FunÃ§Ã£o para redimensionar os grÃ¡ficos
  function resizeCharts() {
    graficoHistorico.resize();
    graficoDistribuicao.resize();
    graficoMensal.resize();
    graficoAnual.resize();
  }

  window.addEventListener('resize', resizeCharts);
</script>

{% endblock %}
