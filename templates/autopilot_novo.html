{% extends "base.html" %}
{% set active_page = 'autopilot' %}
{% block title %}Autopilot Solar | SolarMind{% endblock %}

{% block extra_head %}
<style>
  /* Remove o wrapper glass padrão para autopilot */
  .container .glass {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
    padding: 0 !important;
  }
  
  .autopilot-card {
    background: linear-gradient(135deg, rgba(0, 20, 40, 0.9), rgba(0, 40, 80, 0.7));
    border: 1px solid rgba(0, 191, 255, 0.3);
    border-radius: 20px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
    backdrop-filter: blur(15px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  .autopilot-card:hover {
    transform: translateY(-5px);
    border-color: rgba(0, 191, 255, 0.5);
    box-shadow: 0 15px 45px rgba(0, 0, 0, 0.4);
  }
  
  .metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(45deg, #FE5800, #00bfff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
  }
  
  .status-badge {
    display: inline-block;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 2rem;
  }
  
  .status-active {
    background: linear-gradient(45deg, #00ff41, #28a745);
    color: #000;
    box-shadow: 0 0 25px rgba(0, 255, 65, 0.4);
  }
  
  .recommendation-item {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    height: 100%;
  }
  
  .recommendation-item:hover {
    border-color: rgba(0, 191, 255, 0.4);
    background: rgba(0, 191, 255, 0.08);
    transform: translateY(-2px);
  }
  
  .icon-tech {
    color: #00bfff;
    margin-right: 1rem;
    font-size: 1.5rem;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
  }
  
  .section-title {
    color: #00bfff;
    text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);
    margin-bottom: 2rem;
  }
</style>
{% endblock %}

{% block content %}
<!-- Header Section Expandido -->
<div class="text-center mb-5 py-4">
  <div class="d-inline-block p-4 rounded-circle mb-4" style="background: linear-gradient(45deg, #FE5800, #00bfff); box-shadow: 0 0 40px rgba(254, 88, 0, 0.4);">
    <i class="fa-solid fa-robot fa-4x text-white"></i>
  </div>
  <h1 class="fw-bold mb-4 section-title" style="font-size: 3rem;">AUTOPILOT SOLAR</h1>
  <p class="lead text-light mb-4" style="font-size: 1.2rem;">Sistema de Inteligência Artificial para Otimização Energética</p>
  <div class="status-badge status-active">
    <i class="fa-solid fa-microchip me-2"></i>Sistema Operacional
  </div>
</div>

<!-- === MÉTRICAS PRINCIPAIS === -->
<div class="row g-4 mb-5">
  <div class="col-lg-4 col-md-6">
    <div class="autopilot-card text-center">
      <i class="icon-tech fa-solid fa-clock fa-3x mb-3"></i>
      <h5 class="text-light mb-3">Janela de Pico</h5>
      <div class="metric-value mb-2">{{ plan.peak_window.start }} – {{ plan.peak_window.end }}</div>
      <p class="text-light mb-0">Evite operar cargas intensas nesse período para máxima economia</p>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-6">
    <div class="autopilot-card text-center">
      <i class="icon-tech fa-solid fa-battery-three-quarters fa-3x mb-3"></i>
      <h5 class="text-light mb-3">Estado de Carga</h5>
      <div class="metric-value mb-2">{{ plan.soc }}%</div>
      <p class="text-light mb-0">Geração prevista: <strong style="color: #00bfff;">{{ plan.forecast_kwh }} kWh</strong></p>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-12">
    <div class="autopilot-card">
      <div class="text-center mb-3">
        <i class="icon-tech fa-solid fa-microphone fa-2x mb-2"></i>
        <h5 class="text-light mb-0">Comando Alexa</h5>
      </div>
      <div class="alert alert-info mb-3" style="background: rgba(0, 191, 255, 0.1); border: 1px solid rgba(0, 191, 255, 0.3); color: #00bfff;">
        <i class="fa-solid fa-quote-left me-2"></i>
        {{ plan.alexa_message }}
        <i class="fa-solid fa-quote-right ms-2"></i>
      </div>
      <div class="d-grid">
        <button id="announceBtn" class="btn btn-warning btn-lg">
          <i class="fa-solid fa-volume-up me-2"></i>Anunciar na Alexa
        </button>
        <small id="announceStatus" class="text-center mt-2 text-muted"></small>
      </div>
      <input type="hidden" id="alexaMsgVal" value="{{ plan.alexa_message | e }}" />
    </div>
  </div>
</div>

<!-- === RECOMENDAÇÕES INTELIGENTES === -->
<div class="row mb-5">
  <div class="col-12">
    <div class="autopilot-card">
      <div class="d-flex align-items-center mb-5">
        <i class="icon-tech fa-solid fa-lightbulb fa-3x me-4"></i>
        <h3 class="section-title mb-0">Recomendações Inteligentes</h3>
      </div>
      
      <div class="row g-4">
        {% for rec in plan.recommendations %}
        <div class="col-lg-6">
          <div class="recommendation-item">
            <div class="d-flex align-items-start">
              <i class="fa-solid fa-check-circle text-success me-3 mt-1" style="font-size: 1.3rem;"></i>
              <div>
                <p class="text-light mb-0" style="font-size: 1.1rem; line-height: 1.6;">{{ rec }}</p>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- === CARGAS CRÍTICAS === -->
<div class="row mb-5">
  <div class="col-12">
    <div class="autopilot-card">
      <div class="d-flex align-items-center justify-content-between mb-5">
        <div class="d-flex align-items-center">
          <i class="icon-tech fa-solid fa-exclamation-triangle fa-3x me-4"></i>
          <h3 class="section-title mb-0">Cargas Críticas</h3>
        </div>
        <span class="badge bg-warning text-dark px-3 py-2" style="font-size: 1rem;">Atenção Requerida</span>
      </div>
      
      {% if plan.shed and plan.shed|length > 0 %}
      <div class="row g-4">
        {% for dev in plan.shed %}
        <div class="col-lg-6">
          <div class="recommendation-item border-warning" style="border-color: rgba(255, 193, 7, 0.4) !important; background: rgba(255, 193, 7, 0.05);">
            <div class="d-flex align-items-center">
              <i class="fa-solid fa-bolt text-warning me-3" style="font-size: 1.5rem;"></i>
              <div>
                <p class="text-light mb-1 fw-semibold" style="font-size: 1.1rem;">{{ dev }}</p>
                <small class="text-warning">Reduzir consumo durante horário de pico</small>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fa-solid fa-check-circle text-success fa-4x mb-4"></i>
        <h4 class="text-success mb-3">Sistema Totalmente Otimizado</h4>
        <p class="text-light mb-0" style="font-size: 1.1rem;">Nenhuma carga crítica detectada no momento</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- === CONTROLES === -->
<div class="row mt-5">
  <div class="col-12">
    <div class="autopilot-card text-center">
      <h4 class="section-title mb-4">Controles do Sistema</h4>
      <div class="d-flex justify-content-center gap-3 flex-wrap">
        <a href="{{ url_for('dash.autopilot') }}" class="btn btn-outline-info btn-lg px-4 py-3">
          <i class="fa-solid fa-refresh me-2"></i>Atualizar Plano
        </a>
        <a href="{{ url_for('dash.dashboard') }}" class="btn btn-warning btn-lg px-4 py-3">
          <i class="fa-solid fa-tachometer-alt me-2"></i>Ver Dashboard
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const autopilotMessage = document.getElementById('alexaMsgVal')?.value || '';
  document.getElementById('announceBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('announceBtn');
    const status = document.getElementById('announceStatus');
    btn.disabled = true; status.textContent = 'enviando...';
    try {
      const resp = await fetch('/api/autopilot/announce', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: autopilotMessage })
      });
      const data = await resp.json();
      if (data.status === 'sucesso') {
        status.textContent = 'enviado ✅';
      } else {
        status.textContent = 'erro ❌';
        console.warn('Announce error:', data);
      }
      setTimeout(() => status.textContent = '', 4000);
    } catch (e) {
      status.textContent = 'erro de rede';
      setTimeout(() => status.textContent = '', 4000);
    } finally {
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
