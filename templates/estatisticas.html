{% extends "base.html" %}
{% set active_page = 'estatisticas' %}
{% block title %}Estatísticas | SolarMind{% endblock %}

{% block content %}
<div class="text-center mb-5">
  <i class="fa-solid fa-chart-line fa-4x mb-3" style="color:#FE5800;"></i>
  <h2 class="fw-bold" style="color:#FE5800;">Estatísticas Avançadas</h2>
  <p class="lead text-light">Análises detalhadas e histórico completo do seu sistema solar</p>
</div>

<!-- KPIs em Cards -->
<div class="row g-4 mb-5">
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-solar-panel fa-3x mb-3" style="color:#FE5800;"></i>
      <h6 class="text-light mb-1">Total Gerado</h6>
      <h3 class="fw-bold" style="color:#FE5800;">{{ total_gerado or '3,245' }}</h3>
      <small class="text-light">kWh acumulados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-money-bill-wave fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">Economia Total</h6>
      <h3 class="fw-bold" style="color:#28a745;">R$ {{ economia or '2,434' }}</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-leaf fa-3x mb-3" style="color:#20c997;"></i>
      <h6 class="text-light mb-1">CO₂ Evitado</h6>
      <h3 class="fw-bold" style="color:#20c997;">{{ co2_total or '1,623' }}</h3>
      <small class="text-light">kg de CO₂</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-calendar-days fa-3x mb-3" style="color:#17a2b8;"></i>
      <h6 class="text-light mb-1">Dias Ativos</h6>
      <h3 class="fw-bold" style="color:#17a2b8;">{{ dias_ativos or '287' }}</h3>
      <small class="text-light">dias gerando</small>
    </div>
  </div>
</div>

<!-- Gráficos Aprimorados -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-column fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Geração Mensal</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoMensal"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Comparativo Anual</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoAnual"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gráfico de Tendência Semanal -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-line fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Tendência Semanal</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoSemanal"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de Performance -->
<div class="glass p-4">
  <div class="d-flex align-items-center mb-4">
    <i class="fa-solid fa-table fa-2x me-3" style="color:#FE5800;"></i>
    <h5 class="fw-semibold mb-0" style="color:#FE5800;">Performance Detalhada</h5>
  </div>
  
  <div class="table-responsive">
    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th><i class="fa-solid fa-calendar me-2"></i>Período</th>
          <th><i class="fa-solid fa-bolt me-2"></i>Geração (kWh)</th>
          <th><i class="fa-solid fa-trending-up me-2"></i>Média Diária</th>
          <th><i class="fa-solid fa-money-bill me-2"></i>Economia</th>
          <th><i class="fa-solid fa-leaf me-2"></i>CO₂ Evitado</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Agosto 2025</td>
          <td class="text-warning fw-bold">285.4 kWh</td>
          <td>9.2 kWh/dia</td>
          <td class="text-success">R$ 214,05</td>
          <td class="text-info">142.7 kg</td>
        </tr>
        <tr>
          <td>Julho 2025</td>
          <td class="text-warning fw-bold">312.8 kWh</td>
          <td>10.1 kWh/dia</td>
          <td class="text-success">R$ 234,60</td>
          <td class="text-info">156.4 kg</td>
        </tr>
        <tr>
          <td>Junho 2025</td>
          <td class="text-warning fw-bold">278.2 kWh</td>
          <td>9.3 kWh/dia</td>
          <td class="text-success">R$ 208,65</td>
          <td class="text-info">139.1 kg</td>
        </tr>
        <tr>
          <td>Maio 2025</td>
          <td class="text-warning fw-bold">325.6 kWh</td>
          <td>10.5 kWh/dia</td>
          <td class="text-success">R$ 244,20</td>
          <td class="text-info">162.8 kg</td>
        </tr>
        <tr>
          <td>Abril 2025</td>
          <td class="text-warning fw-bold">289.3 kWh</td>
          <td>9.6 kWh/dia</td>
          <td class="text-success">R$ 217,45</td>
          <td class="text-info">144.7 kg</td>
        </tr>
        <tr>
          <td>Março 2025</td>
          <td class="text-warning fw-bold">342.1 kWh</td>
          <td>11.0 kWh/dia</td>
          <td class="text-success">R$ 256,80</td>
          <td class="text-info">171.1 kg</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Configuração comum dos gráficos
  const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { 
        display: true, 
        labels: { 
          color: '#ffffff',
          font: { size: 14 }
        } 
      },
      tooltip: {
        backgroundColor: 'rgba(0,0,0,0.8)',
        titleColor: '#ffffff',
        bodyColor: '#ffffff',
        borderColor: '#FE5800',
        borderWidth: 1
      }
    },
    scales: {
      x: { 
        grid: { 
          display: false 
        },
        ticks: { 
          color: '#ffffff',
          font: { size: 12 }
        }
      },
      y: { 
        beginAtZero: true, 
        grid: { 
          color: 'rgba(255,255,255,0.1)' 
        },
        ticks: { 
          color: '#ffffff',
          font: { size: 12 }
        }
      }
    }
  };

  // Gráfico Mensal
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  const graficoMensal = new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
      datasets: [{
        label: 'Geração (kWh)',
        data: [245, 278, 342, 289, 325, 278, 313, 285, 289, 298, 276, 312],
        backgroundColor: [
          'rgba(254,88,0,0.8)',
          'rgba(254,88,0,0.7)',
          'rgba(254,88,0,0.9)',
          'rgba(254,88,0,0.7)',
          'rgba(254,88,0,0.9)',
          'rgba(254,88,0,0.7)',
          'rgba(254,88,0,0.8)',
          'rgba(254,88,0,0.8)',
          'rgba(254,88,0,0.7)',
          'rgba(254,88,0,0.8)',
          'rgba(254,88,0,0.7)',
          'rgba(254,88,0,0.8)'
        ],
        borderColor: '#FE5800',
        borderWidth: 2,
        borderRadius: 4,
        borderSkipped: false
      }]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: {
          ...chartConfig.scales.y,
          ticks: {
            ...chartConfig.scales.y.ticks,
            callback: function(value) {
              return value + ' kWh';
            }
          }
        }
      }
    }
  });

  // Gráfico Anual
  const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
  const graficoAnual = new Chart(ctxAnual, {
    type: 'line',
    data: {
      labels: ['2021', '2022', '2023', '2024', '2025'],
      datasets: [{
        label: 'Geração Anual (kWh)',
        data: [2800, 3000, 3200, 3100, 3245],
        borderColor: '#FE5800',
        backgroundColor: 'rgba(254,88,0,0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 8,
        pointBackgroundColor: '#FE5800',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 3,
        pointHoverRadius: 10,
        pointHoverBackgroundColor: '#ffffff',
        pointHoverBorderColor: '#FE5800',
        pointHoverBorderWidth: 3
      }]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: {
          ...chartConfig.scales.y,
          ticks: {
            ...chartConfig.scales.y.ticks,
            callback: function(value) {
              return value.toLocaleString() + ' kWh';
            }
          }
        }
      }
    }
  });

  // Gráfico Semanal (Novo)
  const ctxSemanal = document.getElementById('graficoSemanal').getContext('2d');
  const graficoSemanal = new Chart(ctxSemanal, {
    type: 'line',
    data: {
      labels: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
      datasets: [
        {
          label: 'Semana Atual',
          data: [12.5, 15.2, 18.7, 16.3, 19.1, 17.8, 14.2],
          borderColor: '#FE5800',
          backgroundColor: 'rgba(254,88,0,0.1)',
          tension: 0.4,
          fill: false,
          pointRadius: 6,
          pointBackgroundColor: '#FE5800',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2
        },
        {
          label: 'Semana Anterior',
          data: [11.8, 14.5, 17.2, 15.8, 18.3, 16.9, 13.7],
          borderColor: '#28a745',
          backgroundColor: 'rgba(40,167,69,0.1)',
          tension: 0.4,
          fill: false,
          pointRadius: 4,
          pointBackgroundColor: '#28a745',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      ...chartConfig,
      scales: {
        ...chartConfig.scales,
        y: {
          ...chartConfig.scales.y,
          ticks: {
            ...chartConfig.scales.y.ticks,
            callback: function(value) {
              return value + ' kWh';
            }
          }
        }
      }
    }
  });

  // Função para redimensionar os gráficos
  window.addEventListener('resize', function() {
    graficoMensal.resize();
    graficoAnual.resize();
    graficoSemanal.resize();
  });

  // Animação ao carregar
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      graficoMensal.update('active');
      graficoAnual.update('active');
      graficoSemanal.update('active');
    }, 500);
  });
</script>
{% endblock %}
