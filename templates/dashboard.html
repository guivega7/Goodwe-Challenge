{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard Solar | SolarMind{% endblock %}

{% block extra_head %}
<style>
  /* === DASHBOARD TECH CLEAN === */
  .tech-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .tech-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #FE5800, #00bfff);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .tech-card:hover::before {
    opacity: 1;
  }
  
  .tech-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }
  
  .tech-icon {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #FE5800, #00bfff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    display: inline-block;
  }
  
  .tech-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: #f8fafc;
    margin: 0.5rem 0;
  }
  
  .tech-label {
    color: #94a3b8;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .insight-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.2rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .insight-card:hover {
    border-color: rgba(254, 88, 0, 0.3);
    background: rgba(254, 88, 0, 0.02);
  }
  
  .insight-success {
    border-left: 4px solid #10b981;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent);
  }
  
  .insight-info {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.05), transparent);
  }
  
  .insight-warning {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.05), transparent);
  }
  
  .insight-accent {
    border-left: 4px solid #FE5800;
    background: linear-gradient(90deg, rgba(254, 88, 0, 0.05), transparent);
  }
  
  .status-online {
    color: #10b981;
    font-weight: 600;
  }
  
  .status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .chart-wrapper {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .section-title {
    color: #f8fafc;
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .section-subtitle {
    color: #64748b;
    font-size: 1rem;
    text-align: center;
    margin-bottom: 3rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
<div class="text-center mb-5 smooth-entry">
  <div class="tech-icon mb-3">
    <i class="fa-solid fa-solar-panel"></i>
  </div>
  <h1 class="section-title">Painel Solar Inteligente</h1>
  <p class="section-subtitle">Monitoramento avançado e análise de performance em tempo real</p>
</div>

<!-- === MÉTRICAS PRINCIPAIS === -->
<div class="row g-4 mb-5">
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-bolt"></i>
      </div>
      <h6 class="tech-label mb-2">Potência Atual</h6>
      <div id="kpi-energia-hoje" class="tech-value">{{ relatorio.potencia_atual or '...' }}</div>
      <small class="text-muted">W gerados</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-battery-three-quarters"></i>
      </div>
      <h6 class="tech-label mb-2">SOC Bateria</h6>
      <div id="kpi-soc-bateria" class="tech-value">{{ relatorio.soc_bateria or '...' }}%</div>
      <small class="text-muted">carga atual</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-coins"></i>
      </div>
      <h6 class="tech-label mb-2">Economia Hoje</h6>
      <div id="kpi-economia-hoje" class="tech-value">R$ {{ relatorio.economia_hoje or '...' }}</div>
      <small class="text-muted">economizados</small>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i id="kpi-status-icon" class="fa-solid fa-{% if relatorio.status == 'online' %}wifi{% else %}wifi-slash{% endif %}"></i>
      </div>
      <h6 class="tech-label mb-2">Status Sistema</h6>
      <div id="kpi-status-text" class="tech-value {% if relatorio.status == 'online' %}status-online{% endif %}">
        <span id="kpi-status-indicator" class="status-indicator"></span><span id="kpi-status-label">{{ relatorio.status_texto or 'ONLINE' }}</span>
      </div>
      <small id="kpi-last-update" class="text-muted">{{ relatorio.last_update or '...' }}</small>
    </div>
  </div>
</div>

<!-- Link para Histórico Detalhado -->
<div class="text-center mt-4 mb-5">
    <a href="{{ url_for('dash.history_page') }}" class="btn btn-outline-primary">Ver Histórico Detalhado</a>
  </div>

<!-- === CENTRAL DE INSIGHTS === -->
<div class="row mb-5">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center">
          <div class="tech-icon me-3">
            <i class="fa-solid fa-brain"></i>
          </div>
          <h4 class="section-title mb-0" style="font-size: 1.5rem;">Insights Inteligentes</h4>
        </div>
        <button id="generateInsightsBtn" class="btn-gw">
          <i class="fa-solid fa-magic me-2"></i>Analisar Dados
        </button>
      </div>
      
      <div id="insightsContent">
        {% if insights %}
          {% for ins in insights %}
          <div class="insight-card insight-{{ ins.variant or 'info' }}">
            <div class="d-flex align-items-center">
              <i class="fas {{ ins.icon or 'fa-info-circle' }} me-3 {{ ins.color or 'text-light' }}" style="font-size: 1.4em;"></i>
              <div>
                <strong class="{{ ins.color or 'text-light' }}">{{ ins.titulo }}</strong><br>
                <span class="text-light">{{ ins.texto }}</span>
              </div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-muted">Sem insights no momento.</div>
        {% endif %}
        
        <div class="mt-4 p-3" style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);">
          <small class="text-muted d-flex align-items-center">
            <i class="fas fa-microchip me-2 text-accent-clean"></i>
            <span><strong class="text-accent-clean">IA Neural</strong> processando dados em tempo real • Última análise: <strong class="text-primary-clean">agora</strong></span>
          </small>
        </div>
      </div>
      
      <div id="insightsLoading" class="text-center d-none py-4">
        <div class="spinner-border text-warning me-3" role="status"></div>
        <span class="text-warning">Analisando dados com IA...</span>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos do Dia -->
<div class="row g-4 mb-4">
  <!-- Gráfico de Distribuição de Energia (Hoje) -->
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-pie fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Distribuição Hoje</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoDistribuicao"></canvas>
      </div>
    </div>
  </div>

  <!-- Gráfico Estado da Bateria (Hoje) -->
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-battery-half fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Estado da Bateria Hoje</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoBateria"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Removidos: Geração Mensal, Comparativo Anual e cards acumulados (agora em Histórico) -->

<!-- Controles de Configuração -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-cog fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Configurações e Controle</h5>
      </div>

      <!-- Formulário de Configuração -->
      <form method="GET" class="mb-4">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="fonte" class="form-label text-light">Fonte de Dados</label>
            <select class="form-select" name="fonte" id="fonte" onchange="this.form.submit()">
              <option value="mock" {% if request.args.get('fonte', 'mock') == 'mock' %}selected{% endif %}>Dados Simulados</option>
              <option value="api" {% if request.args.get('fonte') == 'api' %}selected{% endif %}>API Real (SEMS)</option>
            </select>
          </div>
          <!-- Campo de SN removido -->
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-warning me-2">
            <i class="fa-solid fa-sync-alt me-2"></i>Atualizar Dados
          </button>
          <a href="{{ url_for('dash.autopilot') }}" class="btn btn-success">
            <i class="fa-solid fa-robot me-2"></i>Autopilot
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
</div> <!-- fecha container-fluid -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ================== DASHBOARD DINÂMICO ==================
const fonteSelecionada = new URLSearchParams(window.location.search).get('fonte') || 'mock';
console.log('Fonte selecionada:', fonteSelecionada);
let chartHistorico, chartDistribuicao, chartBateria;
// Dados extras (mensal/anual) foram movidos para a página de Histórico

function fmt(num){ if(num===undefined||num===null||isNaN(num)) return 0; return Math.round(num*100)/100; }
async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

function updateKpiCard(id, value, prefix = '', suffix = '') {
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `${prefix}${value}${suffix}`;
    }
}

async function carregarStatus(){ 
    if(fonteSelecionada!=='api') return; 
    try{ 
        console.log('Carregando status...');
        const res = await fetchJSON('/api/solar/status'); 
        console.log('Resposta status:', res);
        if(!res.ok) return;
        const status = res.data;
        const isOnline = status.status === 'online';
        
        updateKpiCard('kpi-status-label', status.status.toUpperCase());
        document.getElementById('kpi-status-indicator').style.display = isOnline ? 'inline-block' : 'none';
        const icon = document.getElementById('kpi-status-icon');
        icon.className = `fa-solid ${isOnline ? 'fa-wifi' : 'fa-wifi-slash'}`;
        document.getElementById('kpi-status-text').classList.toggle('status-online', isOnline);
        updateKpiCard('kpi-last-update', new Date(res.data.timestamp).toLocaleTimeString());
        
        // Atualizar potência atual
        const potenciaAtual = status.potencia_atual || 0;
        updateKpiCard('kpi-energia-hoje', fmt(potenciaAtual));

    } catch(e){ console.warn('status fail', e);} 
}

async function carregarData(){ 
    if(fonteSelecionada!=='api') return; 
    try{ 
        console.log('Carregando data...');
        const res = await fetchJSON('/api/solar/data'); 
        console.log('Resposta data:', res);
        if(!res.ok) return; 
        const data = res.data; // CORREÇÃO: Acessar res.data diretamente
        console.log('Dados extraídos:', data);
        const prodHoje = data.producao.hoje; 
        const consumoHoje = data.consumo?.hoje || 0; 
        
        updateKpiCard('kpi-energia-hoje', fmt(prodHoje));
        updateKpiCard('kpi-soc-bateria', fmt(data.bateria.soc), '', '%');
        updateKpiCard('kpi-economia-hoje', fmt(data.economia.hoje), 'R$ ');

        atualizarDistribuicao(prodHoje, consumoHoje); 
    } catch(e){ console.warn('data fail', e);} 
}

async function carregarHistorico(){ 
  if(fonteSelecionada!=='api') return; 
    try{ 
        console.log('Carregando histórico...');
        const res = await fetchJSON('/api/solar/history?days=7'); 
        console.log('Resposta histórico:', res);
        if(!res.ok) return; 
        const hist = res.data; // CORREÇÃO: Acessar res.data diretamente
        console.log('Histórico extraído:', hist);
        const labels = hist.map(h=> h.data.slice(5)); 
        const geracao = hist.map(h=> fmt(h.producao)); 
        const consumo = geracao.map(v=> fmt(v*0.8)); // Consumo estimado
  atualizarHistorico(labels, geracao, consumo); 
    } catch(e){ console.warn('history fail', e);} 
}

function initCharts(){
  const elHist = document.getElementById('graficoHistorico');
  if (elHist) {
    chartHistorico = new Chart(elHist, { type:'line', data:{ labels:[], datasets:[ {label:'Energia Gerada (kWh)', data:[], borderColor:'#FE5800', backgroundColor:'rgba(254,88,0,0.15)', tension:0.35, fill:true}, {label:'Energia Consumida (kWh)', data:[], borderColor:'#17a2b8', backgroundColor:'rgba(23,162,184,0.15)', tension:0.35, fill:true} ]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#fff'} } }, scales:{ y:{ beginAtZero:true, ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'} }, x:{ ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'} } } } });
  }
  const elDist = document.getElementById('graficoDistribuicao');
  if (elDist) {
    chartDistribuicao = new Chart(elDist, { type:'doughnut', data:{ labels:['Energia Gerada','Energia Consumida','Excedente'], datasets:[{ data:[0,0,0], backgroundColor:['#FE5800','#17a2b8','#28a745'], borderColor:'#fff', borderWidth:2 }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom', labels:{ color:'#fff', padding:20 } } } } });
  }
  const elBat = document.getElementById('graficoBateria');
  if (elBat) {
    chartBateria = new Chart(elBat, { type:'line', data:{ labels:[], datasets:[{label:'SOC Bateria (%)', data:[], borderColor:'#00bfff', backgroundColor:'rgba(0,191,255,0.15)', tension:0.35, fill:true}]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#fff'} } }, scales:{ y:{ beginAtZero:true, max:100, ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'} }, x:{ ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.1)'} } } } });
  }
}

function atualizarHistorico(labels, geracao, consumo){ if(!chartHistorico) return; chartHistorico.data.labels = labels; chartHistorico.data.datasets[0].data = geracao; chartHistorico.data.datasets[1].data = consumo; chartHistorico.update(); }
function atualizarDistribuicao(gerado, consumido){ if(!chartDistribuicao) return; const excedente = Math.max(0, fmt(gerado - consumido)); chartDistribuicao.data.datasets[0].data = [fmt(gerado), fmt(consumido), excedente]; chartDistribuicao.update(); }
// Função para popular gráficos em modo mock usando dados backend (injetados em 'data')
function popularMock(){
  try {
    const backend = JSON.parse(String.raw`{{ data|tojson|safe }}`);
    if(!backend || !backend.Eday) return;
    // Histórico 7 dias (já vem no relatorio) – usamos apenas Eday de hoje para linha? manter simples
    const eday = backend.Eday;
    const labelsHist = eday.map(p => p[0].slice(11,16));
    const geracao = eday.map((p,i)=> i===0? fmt(p[1]) : fmt(p[1]));
    const consumo = geracao.map(v=> fmt(v*0.8));
    atualizarHistorico(labelsHist, geracao, consumo);
    // Distribuição (último valor)
    const prodHoje = geracao.length ? geracao[geracao.length-1] : 0;
    atualizarDistribuicao(prodHoje, fmt(prodHoje*0.75));
    // Bateria
    if(backend.Cbattery1){
      const labelsBat = backend.Cbattery1.map(p => p[0].slice(11,16));
      const socVals = backend.Cbattery1.map(p => p[1]);
      chartBateria.data.labels = labelsBat;
      chartBateria.data.datasets[0].data = socVals;
      chartBateria.update();
    }
  } catch(err){ console.warn('popularMock falhou', err); }
}

async function cicloRefresh(){ 
    console.log('Iniciando cicloRefresh para fonte:', fonteSelecionada);
    if(fonteSelecionada==='api'){ 
        await carregarStatus(); 
        await carregarData(); 
        await carregarHistorico();
    } 
}
initCharts();
if(fonteSelecionada==='api'){
  console.log('Configurando refresh para API');
  cicloRefresh();
  setInterval(()=> carregarStatus(), 30000);
  setInterval(()=> carregarData(), 120000);
  setInterval(()=> carregarHistorico(), 300000);
} else {
  console.log('Modo mock, sem refresh');
  // Popular gráficos imediatamente com dados mock do backend
  popularMock();
}

// Insights geração (já existia) - manter se necessário
// document.getElementById('generateInsightsBtn') ... se existir manter comportamento anterior
</script>
{% endblock %}
