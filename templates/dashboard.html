{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard Solar | SolarMind{% endblock %}

{% block extra_head %}
<style>
  /* === DASHBOARD TECH CLEAN === */
  .tech-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .tech-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #FE5800, #00bfff);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .tech-card:hover::before {
    opacity: 1;
  }
  
  .tech-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  }
  
  .tech-icon {
    font-size: 2.5rem;
    background: linear-gradient(135deg, #FE5800, #00bfff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    display: inline-block;
  }
  
  .tech-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: #f8fafc;
    margin: 0.5rem 0;
  }
  
  .tech-label {
    color: #94a3b8;
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .insight-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1.2rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .insight-card:hover {
    border-color: rgba(254, 88, 0, 0.3);
    background: rgba(254, 88, 0, 0.02);
  }
  
  .insight-success {
    border-left: 4px solid #10b981;
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.05), transparent);
  }
  
  .insight-info {
    border-left: 4px solid #3b82f6;
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.05), transparent);
  }
  
  .insight-warning {
    border-left: 4px solid #f59e0b;
    background: linear-gradient(90deg, rgba(245, 158, 11, 0.05), transparent);
  }
  
  .insight-accent {
    border-left: 4px solid #FE5800;
    background: linear-gradient(90deg, rgba(254, 88, 0, 0.05), transparent);
  }
  
  .status-online {
    color: #10b981;
    font-weight: 600;
  }
  
  .status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .chart-wrapper {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .section-title {
    color: #f8fafc;
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  .section-subtitle {
    color: #64748b;
    font-size: 1rem;
    text-align: center;
    margin-bottom: 3rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
<div class="text-center mb-5 smooth-entry">
  <div class="tech-icon mb-3">
    <i class="fa-solid fa-solar-panel"></i>
  </div>
  <h1 class="section-title">Painel Solar Inteligente</h1>
  <p class="section-subtitle">Monitoramento avançado e análise de performance em tempo real</p>
</div>

<!-- === MÉTRICAS PRINCIPAIS === -->
<div class="row g-4 mb-5">
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-bolt"></i>
      </div>
      <h6 class="tech-label mb-2">Energia Hoje</h6>
      <div class="tech-value">{{ relatorio.energia_hoje or '16.8' }}</div>
      <small class="text-muted">kWh gerados</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-battery-three-quarters"></i>
      </div>
      <h6 class="tech-label mb-2">SOC Bateria</h6>
      <div class="tech-value">{{ relatorio.soc_bateria or '76' }}%</div>
      <small class="text-muted">carga atual</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-coins"></i>
      </div>
      <h6 class="tech-label mb-2">Economia Hoje</h6>
      <div class="tech-value">R$ {{ relatorio.economia_hoje or '12.40' }}</div>
      <small class="text-muted">economizados</small>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="tech-card p-4 text-center">
      <div class="tech-icon">
        <i class="fa-solid fa-{% if relatorio.status == 'online' %}wifi{% else %}wifi-slash{% endif %}"></i>
      </div>
      <h6 class="tech-label mb-2">Status Sistema</h6>
      <div class="tech-value {% if relatorio.status == 'online' %}status-online{% endif %}">
        <span class="status-indicator"></span>{{ relatorio.status_texto or 'ONLINE' }}
      </div>
      <small class="text-muted">{{ relatorio.last_update or 'atualizado agora' }}</small>
    </div>
  </div>
</div>

<!-- Estatísticas Acumuladas -->
<div class="row g-4 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-solar-panel fa-3x mb-3" style="color:#FE5800;"></i>
      <h6 class="text-light mb-1">Total Gerado</h6>
      <h3 class="fw-bold" style="color:#FE5800;">3,245.8</h3>
      <small class="text-light">kWh acumulados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-piggy-bank fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">Economia Total</h6>
      <h3 class="fw-bold" style="color:#28a745;">R$ 2,434.35</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-leaf fa-3x mb-3" style="color:#20c997;"></i>
      <h6 class="text-light mb-1">CO₂ Evitado</h6>
      <h3 class="fw-bold" style="color:#20c997;">1,623.0</h3>
      <small class="text-light">kg de CO₂</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-calendar-days fa-3x mb-3" style="color:#17a2b8;"></i>
      <h6 class="text-light mb-1">Dias Ativos</h6>
      <h3 class="fw-bold" style="color:#17a2b8;">287</h3>
      <small class="text-light">dias gerando</small>
    </div>
  </div>
</div>

<!-- === CENTRAL DE INSIGHTS === -->
<div class="row mb-5">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center">
          <div class="tech-icon me-3">
            <i class="fa-solid fa-brain"></i>
          </div>
          <h4 class="section-title mb-0" style="font-size: 1.5rem;">Insights Inteligentes</h4>
        </div>
        <button id="generateInsightsBtn" class="btn-gw">
          <i class="fa-solid fa-magic me-2"></i>Analisar Dados
        </button>
      </div>
      
      <div id="insightsContent">
        <!-- Insight Performance -->
        <div class="insight-card insight-success">
          <div class="d-flex align-items-center">
            <i class="fas fa-solar-panel me-3 text-success" style="font-size: 1.4em;"></i>
            <div>
              <strong class="text-success">Performance Excelente</strong><br>
              <span class="text-light">Sistema gerando <strong class="text-accent-clean">25.3 kWh</strong> com eficiência de <strong class="text-accent-clean">135%</strong> do consumo</span>
            </div>
          </div>
        </div>
        
        <!-- Insight Bateria -->
        <div class="insight-card insight-info">
          <div class="d-flex align-items-center">
            <i class="fas fa-battery-three-quarters me-3 text-primary" style="font-size: 1.4em;"></i>
            <div>
              <strong class="text-primary-clean">Armazenamento Otimizado</strong><br>
              <span class="text-light">Bateria em <strong class="text-accent-clean">87%</strong> - autonomia estimada até <strong class="text-accent-clean">18h</strong></span>
            </div>
          </div>
        </div>
        
        <!-- Insight Ambiental -->
        <div class="insight-card insight-warning">
          <div class="d-flex align-items-center">
            <i class="fas fa-leaf me-3 text-warning" style="font-size: 1.4em;"></i>
            <div>
              <strong class="text-warning">Impacto Sustentável</strong><br>
              <span class="text-light">CO₂ evitado: <strong class="text-accent-clean">12.6kg</strong> equivale a <strong class="text-accent-clean">6.3km</strong> de carro não rodados</span>
            </div>
          </div>
        </div>
        
        <!-- Insight Recomendação -->
        <div class="insight-card insight-accent">
          <div class="d-flex align-items-center">
            <i class="fas fa-lightbulb me-3 text-accent-clean" style="font-size: 1.4em;"></i>
            <div>
              <strong class="text-accent-clean">Recomendação Inteligente</strong><br>
              <span class="text-light">Use máquina de lavar às <strong class="text-success">14h</strong> para economizar <strong class="text-success">R$ 2,50</strong></span>
            </div>
          </div>
        </div>
        
        <div class="mt-4 p-3" style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);">
          <small class="text-muted d-flex align-items-center">
            <i class="fas fa-microchip me-2 text-accent-clean"></i>
            <span><strong class="text-accent-clean">IA Neural</strong> processando dados em tempo real • Última análise: <strong class="text-primary-clean">agora</strong></span>
          </small>
        </div>
      </div>
      
      <div id="insightsLoading" class="text-center d-none py-4">
        <div class="spinner-border text-warning me-3" role="status"></div>
        <span class="text-warning">Analisando dados com IA...</span>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos Combinados -->
<div class="row g-4 mb-4">
  <!-- Gráfico Histórico 7 Dias -->
  <div class="col-lg-8">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Histórico dos Últimos 7 Dias</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoHistorico"></canvas>
      </div>
    </div>
  </div>

  <!-- Gráfico de Distribuição de Energia -->
  <div class="col-lg-4">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-pie fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Distribuição Hoje</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoDistribuicao"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos Estatísticas (Mensal e Anual) -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-column fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Geração Mensal</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoMensal"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Comparativo Anual</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoAnual"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Controles de Configuração -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-cog fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Configurações e Controle</h5>
      </div>

      <!-- Formulário de Configuração -->
      <form method="POST" class="mb-4">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="fonte" class="form-label text-light">Fonte de Dados</label>
            <select class="form-select" name="fonte" id="fonte" onchange="toggleSnInput()">
              <option value="mock" {% if request.args.get('fonte', 'mock') == 'mock' %}selected{% endif %}>Dados Simulados</option>
              <option value="api" {% if request.args.get('fonte') == 'api' %}selected{% endif %}>API Real (SEMS)</option>
            </select>
          </div>
          
          <div class="col-md-6" id="snContainer" style="{% if request.args.get('fonte', 'mock') == 'mock' %}display:none;{% endif %}">
            <label for="sn" class="form-label text-light">Serial Number (SN)</label>
            <input type="text" class="form-control" name="sn" id="sn" 
                   value="{{ request.args.get('sn', '') }}" 
                   placeholder="Digite o SN do seu inversor">
          </div>
        </div>
        
        <div class="mt-3">
          <button type="submit" class="btn btn-warning me-2">
            <i class="fa-solid fa-sync-alt me-2"></i>Atualizar Dados
          </button>
          <a href="{{ url_for('dash.autopilot') }}" class="btn btn-success">
            <i class="fa-solid fa-robot me-2"></i>Autopilot
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
</div> <!-- fecha container-fluid -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Função para mostrar/esconder campo SN
  function toggleSnInput() {
    const fonte = document.querySelector('select[name="fonte"]').value;
    const snContainer = document.getElementById('snContainer');
    if (fonte === 'api') {
      snContainer.style.display = 'block';
    } else {
      snContainer.style.display = 'none';
    }
  }

  // Dados para gráficos combinados
  const dadosHistorico = [
    {data: 'Hoje', energia: {{ relatorio.energia_hoje or 16.8 }}}
  ];

  // Dados simulados para 7 dias
  const labels7Dias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
  const dadosEnergia7Dias = [14.2, 18.7, 21.3, 16.8, 19.4, 22.1, {{ relatorio.energia_hoje or 16.8 }}];
  const dadosConsumo7Dias = [18.5, 16.2, 17.8, 20.1, 15.9, 19.3, {{ relatorio.energia_consumida or 15.2 }}];

  // Gráfico Histórico 7 Dias
  const ctxHistorico = document.getElementById('graficoHistorico').getContext('2d');
  new Chart(ctxHistorico, {
    type: 'line',
    data: {
      labels: labels7Dias,
      datasets: [{
        label: 'Energia Gerada (kWh)',
        data: dadosEnergia7Dias,
        borderColor: '#FE5800',
        backgroundColor: 'rgba(254, 88, 0, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'Energia Consumida (kWh)',
        data: dadosConsumo7Dias,
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Gráfico de Distribuição
  const ctxDistribuicao = document.getElementById('graficoDistribuicao').getContext('2d');
  new Chart(ctxDistribuicao, {
    type: 'doughnut',
    data: {
      labels: ['Energia Gerada', 'Energia Consumida', 'Energia Injetada'],
      datasets: [{
        data: [{{ relatorio.energia_hoje or 16.8 }}, {{ relatorio.energia_consumida or 15.2 }}, {{ (relatorio.energia_hoje or 16.8) - (relatorio.energia_consumida or 15.2) }}],
        backgroundColor: ['#FE5800', '#17a2b8', '#28a745'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 20 }
        }
      }
    }
  });

  // Dados estatísticas mensais/anuais
  const labelsMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  const dadosMensais = [245, 278, 312, 289, 267, 234, 201, 256, 289, 298, 276, 312];

  // Gráfico Mensal
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: labelsMeses,
      datasets: [{
        label: 'Geração Mensal (kWh)',
        data: dadosMensais,
        backgroundColor: '#FE5800',
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Gráfico Anual
  const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
  new Chart(ctxAnual, {
    type: 'line',
    data: {
      labels: ['2021', '2022', '2023', '2024', '2025'],
      datasets: [{
        label: 'Geração Anual (kWh)',
        data: [2800, 3000, 3200, 3100, 3245],
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Função para gerar insights
  function refreshInsights() {
    const btn = document.getElementById('generateInsightsBtn');
    const loading = document.getElementById('insightsLoading');
    const content = document.getElementById('insightsContent');
    
    btn.disabled = true;
    loading.classList.remove('d-none');
    content.style.opacity = '0.5';
    
    fetch('/api/insights', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok && data.insights && data.insights.length > 0) {
        let insightsHtml = '';
        data.insights.forEach((insight, index) => {
          const colors = [
            { bg: 'rgba(40, 167, 69, 0.1)', border: '#28a745', textClass: 'text-success', icon: 'fa-solar-panel' },
            { bg: 'rgba(0, 123, 255, 0.1)', border: '#007bff', textClass: 'text-primary', icon: 'fa-battery-three-quarters' },
            { bg: 'rgba(255, 193, 7, 0.1)', border: '#ffc107', textClass: 'text-warning', icon: 'fa-leaf' }
          ];
          const color = colors[index % colors.length];
          
          insightsHtml += `
            <div class="insight-card" style="background: ${color.bg}; border: 2px solid ${color.border}; border-radius: 15px; margin-bottom: 15px; padding: 20px;">
              <div class="d-flex align-items-center">
                <i class="fas ${color.icon} me-3 ${color.textClass}" style="font-size: 1.8em;"></i>
                <div class="flex-grow-1">
                  <span class="text-light">${insight}</span>
                </div>
              </div>
            </div>
          `;
        });
        
        // Adicionar fonte se disponível
        if (data.source) {
          insightsHtml += `
            <div class="mt-3 p-2 text-center" style="background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
              <small class="text-muted">
                <i class="fas fa-robot me-1 text-accent-clean"></i>
                Gerado por ${data.source === 'gemini_ai' ? 'Inteligência Artificial' : 'Sistema SolarMind'}
              </small>
            </div>
          `;
        }
        
        content.innerHTML = insightsHtml;
      } else {
        content.innerHTML = `
          <div class="insight-card insight-warning" style="background: #ffc107; border: 2px solid #e0a800;">
            <div class="d-flex align-items-center">
              <i class="fas fa-exclamation-triangle me-3 text-warning" style="font-size: 1.4em;"></i>
              <div>
                <strong class="text-warning">Nenhum insight disponível</strong><br>
                <span class="text-light">Não foi possível gerar insights no momento.</span>
              </div>
            </div>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Erro ao gerar insights:', error);
      content.innerHTML = `
        <div class="insight-card insight-danger" style="background: #dc3545; border: 2px solid #bd2130;">
          <div class="d-flex align-items-center">
            <i class="fas fa-times-circle me-3 text-danger" style="font-size: 1.4em;"></i>
            <div>
              <strong class="text-danger">Erro ao gerar insights</strong><br>
              <span class="text-light">Tente novamente em alguns instantes.</span>
            </div>
          </div>
        </div>
      `;
    })
    .finally(() => {
      btn.disabled = false;
      loading.classList.add('d-none');
      content.style.opacity = '1';
    });
  }

  // Conectar o botão de insights ao event listener
  document.getElementById('generateInsightsBtn').addEventListener('click', refreshInsights);
</script>
{% endblock %}
