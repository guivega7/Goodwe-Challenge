{% extends "base.html" %}
{% set active_page = 'dashboard' %}
{% block title %}Dashboard Solar | SolarMind{% endblock %}

{% block content %}
<div class="text-center mb-4">
  <i class="fa-solid fa-tachometer-alt fa-4x mb-3" style="color:#FE5800;"></i>
  <h2 class="fw-bold" style="color:#FE5800;">Dashboard Solar Completo</h2>
  <p class="lead text-light">Controle total do seu sistema de energia solar</p>
</div>

<!-- KPI Cards com dados em tempo real -->
<div class="row g-4 mb-4">
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-bolt fa-3x mb-3" style="color:#ffc107;"></i>
      <h6 class="text-light mb-1">Energia Hoje</h6>
      <h3 class="fw-bold" style="color:#ffc107;">{{ relatorio.energia_hoje or '16.8' }}</h3>
      <small class="text-light">kWh gerados</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-battery-three-quarters fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">SOC Bateria</h6>
      <h3 class="fw-bold" style="color:#28a745;">{{ relatorio.soc_bateria or '76' }}</h3>
      <small class="text-light">% carregada</small>
    </div>
  </div>
  
  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-money-bill-wave fa-3x mb-3" style="color:#17a2b8;"></i>
      <h6 class="text-light mb-1">Economia Hoje</h6>
      <h3 class="fw-bold" style="color:#17a2b8;">R$ {{ relatorio.economia_hoje or '12.40' }}</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-{% if relatorio.status == 'online' %}wifi{% else %}wifi-slash{% endif %} fa-3x mb-3" 
         style="color:{% if relatorio.status == 'online' %}#28a745{% else %}#6c757d{% endif %};"></i>
      <h6 class="text-light mb-1">Status Sistema</h6>
      <h3 class="fw-bold" style="color:{% if relatorio.status == 'online' %}#28a745{% else %}#6c757d{% endif %};">
        {{ relatorio.status_texto or 'Online' }}
      </h3>
      <small class="text-light">{{ relatorio.last_update or 'Atualizado agora' }}</small>
    </div>
  </div>
</div>

<!-- Estatísticas Acumuladas -->
<div class="row g-4 mb-4">
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-solar-panel fa-3x mb-3" style="color:#FE5800;"></i>
      <h6 class="text-light mb-1">Total Gerado</h6>
      <h3 class="fw-bold" style="color:#FE5800;">3,245.8</h3>
      <small class="text-light">kWh acumulados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-piggy-bank fa-3x mb-3" style="color:#28a745;"></i>
      <h6 class="text-light mb-1">Economia Total</h6>
      <h3 class="fw-bold" style="color:#28a745;">R$ 2,434.35</h3>
      <small class="text-light">economizados</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-leaf fa-3x mb-3" style="color:#20c997;"></i>
      <h6 class="text-light mb-1">CO₂ Evitado</h6>
      <h3 class="fw-bold" style="color:#20c997;">1,623.0</h3>
      <small class="text-light">kg de CO₂</small>
    </div>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-calendar-days fa-3x mb-3" style="color:#17a2b8;"></i>
      <h6 class="text-light mb-1">Dias Ativos</h6>
      <h3 class="fw-bold" style="color:#17a2b8;">287</h3>
      <small class="text-light">dias gerando</small>
    </div>
  </div>
</div>

<!-- Card de Insights IA -->
<div class="row mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <i class="fa-solid fa-brain fa-2x me-3" style="color:#FE5800;"></i>
          <h5 class="fw-semibold mb-0" style="color:#FE5800;">Insights IA Solar</h5>
        </div>
        <button id="generateInsightsBtn" class="btn btn-warning">
          <i class="fa-solid fa-sparkles me-2"></i>Gerar Insights
        </button>
      </div>
      
      <div id="insightsContent">
        <!-- Insights com cores SUPER LEGÍVEIS -->
        <div class="alert mb-3" style="background: linear-gradient(135deg, #28a745, #20c997); border: 3px solid #28a745; color: #ffffff; box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); border-radius: 15px;">
          <i class="fas fa-sun me-2" style="font-size: 1.4em; color: #ffeb3b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          <strong style="color: #ffffff; font-size: 1.2em; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">🌞 PARABÉNS!</strong> 
          <span style="color: #ffffff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Você gerou <strong style="color: #ffeb3b; font-size: 1.1em;">25.3 kWh</strong> hoje e consumiu <strong style="color: #ffeb3b; font-size: 1.1em;">18.7 kWh</strong>. 
          Sua energia solar cobriu <strong style="color: #ffeb3b; font-size: 1.3em; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 5px;">135%</strong> do consumo! Continue aproveitando esses dias ensolarados.</span>
        </div>
        
        <div class="alert mb-3" style="background: linear-gradient(135deg, #17a2b8, #6f42c1); border: 3px solid #17a2b8; color: #ffffff; box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4); border-radius: 15px;">
          <i class="fas fa-battery-three-quarters me-2" style="font-size: 1.4em; color: #28a745; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          <strong style="color: #ffffff; font-size: 1.2em; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">🔋 BATERIA EM 87%</strong> 
          <span style="color: #ffffff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">- perfeita para o horário de ponta! 
          Use energia à vontade até <strong style="color: #ffeb3b; font-size: 1.1em; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 5px;">18h</strong>, depois economize para passar a noite sem custo extra.</span>
        </div>
        
        <div class="alert mb-3" style="background: linear-gradient(135deg, #ffc107, #fd7e14); border: 3px solid #ffc107; color: #000000; box-shadow: 0 6px 20px rgba(255, 193, 7, 0.4); border-radius: 15px;">
          <i class="fas fa-leaf me-2" style="font-size: 1.4em; color: #28a745; text-shadow: 0 2px 4px rgba(255,255,255,0.5);"></i>
          <strong style="color: #000000; font-size: 1.2em; text-shadow: 0 1px 2px rgba(255,255,255,0.5);">🌱 IMPACTO AMBIENTAL:</strong> 
          <span style="color: #000000; font-weight: 700; text-shadow: 0 1px 2px rgba(255,255,255,0.3);">evitou <strong style="color: #dc3545; font-size: 1.1em; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 5px;">12.6kg de CO2</strong> hoje! 
          Equivale a <strong style="color: #dc3545; font-size: 1.1em; background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 5px;">6.3 km</strong> não rodados de carro. Continue fazendo a diferença!</span>
        </div>
        
        <div class="alert mb-3" style="background: linear-gradient(135deg, #FE5800, #dc3545); border: 3px solid #FE5800; color: #ffffff; box-shadow: 0 6px 20px rgba(254, 88, 0, 0.4); border-radius: 15px;">
          <i class="fas fa-lightbulb me-2" style="font-size: 1.4em; color: #ffeb3b; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></i>
          <strong style="color: #ffffff; font-size: 1.2em; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">💡 DICA DO DIA:</strong> 
          <span style="color: #ffffff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Programe sua máquina de lavar para <strong style="color: #ffeb3b; font-size: 1.1em; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 5px;">14h</strong> - você tem energia solar sobrando e vai economizar <strong style="color: #4caf50; font-size: 1.1em; background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 5px;">R$ 2,50!</strong></span>
        </div>
        
        <div class="mt-4 p-3" style="background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.25)); border-radius: 15px; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 4px 15px rgba(255,255,255,0.1);">
          <small style="color: #ffffff; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
            <i class="fas fa-info-circle me-2" style="color: #17a2b8; font-size: 1.1em;"></i>
            <strong style="color: #ffeb3b;">Insights atualizados em tempo real</strong> com base nos seus dados. Clique em "Gerar Insights" para análises personalizadas com IA.
          </small>
        </div>
      </div>
      
      <div id="insightsLoading" class="text-center d-none py-3">
        <div class="spinner-border spinner-border-sm text-warning me-2" role="status"></div>
        <span class="text-warning">Analisando dados com IA...</span>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos Combinados -->
<div class="row g-4 mb-4">
  <!-- Gráfico Histórico 7 Dias -->
  <div class="col-lg-8">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Histórico dos Últimos 7 Dias</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoHistorico"></canvas>
      </div>
    </div>
  </div>

  <!-- Gráfico de Distribuição de Energia -->
  <div class="col-lg-4">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-chart-pie fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Distribuição Hoje</h5>
      </div>
      <div style="position: relative; height: 400px;">
        <canvas id="graficoDistribuicao"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos Estatísticas (Mensal e Anual) -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-column fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Geração Mensal</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoMensal"></canvas>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-area fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Comparativo Anual</h5>
      </div>
      <div style="position: relative; height: 300px;">
        <canvas id="graficoAnual"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Controles de Configuração -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-4">
        <i class="fa-solid fa-cog fa-2x me-3" style="color:#FE5800;"></i>
        <h5 class="fw-semibold mb-0" style="color:#FE5800;">Configurações e Controle</h5>
      </div>

      <!-- Formulário de Configuração -->
      <form method="POST" class="mb-4">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="fonte" class="form-label text-light">Fonte de Dados</label>
            <select class="form-select" name="fonte" id="fonte" onchange="toggleSnInput()">
              <option value="mock" {% if request.args.get('fonte', 'mock') == 'mock' %}selected{% endif %}>Dados Simulados</option>
              <option value="api" {% if request.args.get('fonte') == 'api' %}selected{% endif %}>API Real (SEMS)</option>
            </select>
          </div>
          
          <div class="col-md-6" id="snContainer" style="{% if request.args.get('fonte', 'mock') == 'mock' %}display:none;{% endif %}">
            <label for="sn" class="form-label text-light">Serial Number (SN)</label>
            <input type="text" class="form-control" name="sn" id="sn" 
                   value="{{ request.args.get('sn', '') }}" 
                   placeholder="Digite o SN do seu inversor">
          </div>
        </div>
        
        <div class="mt-3">
          <button type="submit" class="btn btn-warning me-2">
            <i class="fa-solid fa-sync-alt me-2"></i>Atualizar Dados
          </button>
          <a href="{{ url_for('dash.autopilot') }}" class="btn btn-success">
            <i class="fa-solid fa-robot me-2"></i>Autopilot
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Função para mostrar/esconder campo SN
  function toggleSnInput() {
    const fonte = document.querySelector('select[name="fonte"]').value;
    const snContainer = document.getElementById('snContainer');
    if (fonte === 'api') {
      snContainer.style.display = 'block';
    } else {
      snContainer.style.display = 'none';
    }
  }

  // Dados para gráficos combinados
  const dadosHistorico = [
    {data: 'Hoje', energia: {{ relatorio.energia_hoje or 16.8 }}}
  ];

  // Dados simulados para 7 dias
  const labels7Dias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
  const dadosEnergia7Dias = [14.2, 18.7, 21.3, 16.8, 19.4, 22.1, {{ relatorio.energia_hoje or 16.8 }}];
  const dadosConsumo7Dias = [18.5, 16.2, 17.8, 20.1, 15.9, 19.3, {{ relatorio.energia_consumida or 15.2 }}];

  // Gráfico Histórico 7 Dias
  const ctxHistorico = document.getElementById('graficoHistorico').getContext('2d');
  new Chart(ctxHistorico, {
    type: 'line',
    data: {
      labels: labels7Dias,
      datasets: [{
        label: 'Energia Gerada (kWh)',
        data: dadosEnergia7Dias,
        borderColor: '#FE5800',
        backgroundColor: 'rgba(254, 88, 0, 0.1)',
        tension: 0.4,
        fill: true
      }, {
        label: 'Energia Consumida (kWh)',
        data: dadosConsumo7Dias,
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Gráfico de Distribuição
  const ctxDistribuicao = document.getElementById('graficoDistribuicao').getContext('2d');
  new Chart(ctxDistribuicao, {
    type: 'doughnut',
    data: {
      labels: ['Energia Gerada', 'Energia Consumida', 'Energia Injetada'],
      datasets: [{
        data: [{{ relatorio.energia_hoje or 16.8 }}, {{ relatorio.energia_consumida or 15.2 }}, {{ (relatorio.energia_hoje or 16.8) - (relatorio.energia_consumida or 15.2) }}],
        backgroundColor: ['#FE5800', '#17a2b8', '#28a745'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 20 }
        }
      }
    }
  });

  // Dados estatísticas mensais/anuais
  const labelsMeses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  const dadosMensais = [245, 278, 312, 289, 267, 234, 201, 256, 289, 298, 276, 312];

  // Gráfico Mensal
  const ctxMensal = document.getElementById('graficoMensal').getContext('2d');
  new Chart(ctxMensal, {
    type: 'bar',
    data: {
      labels: labelsMeses,
      datasets: [{
        label: 'Geração Mensal (kWh)',
        data: dadosMensais,
        backgroundColor: '#FE5800',
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Gráfico Anual
  const ctxAnual = document.getElementById('graficoAnual').getContext('2d');
  new Chart(ctxAnual, {
    type: 'line',
    data: {
      labels: ['2021', '2022', '2023', '2024', '2025'],
      datasets: [{
        label: 'Geração Anual (kWh)',
        data: [2800, 3000, 3200, 3100, 3245],
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#fff' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        },
        x: {
          ticks: { color: '#fff' },
          grid: { color: 'rgba(255,255,255,0.1)' }
        }
      }
    }
  });

  // Função para gerar insights
  function refreshInsights() {
    const btn = document.getElementById('generateInsightsBtn');
    const loading = document.getElementById('insightsLoading');
    const content = document.getElementById('insightsContent');
    
    btn.disabled = true;
    loading.classList.remove('d-none');
    content.style.opacity = '0.5';
    
    fetch('/api/insights', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        energia_gerada: {{ relatorio.energia_hoje or 16.8 }},
        energia_consumida: {{ relatorio.energia_consumida or 15.2 }},
        soc_bateria: {{ relatorio.soc_bateria or 76 }}
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'sucesso') {
        // Atualiza com insights reais da IA
        console.log('Insights gerados:', data.insights);
      }
    })
    .catch(error => {
      console.error('Erro ao gerar insights:', error);
    })
    .finally(() => {
      btn.disabled = false;
      loading.classList.add('d-none');
      content.style.opacity = '1';
    });
  }
</script>
{% endblock %}
