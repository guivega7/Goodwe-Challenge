{% extends "base.html" %}
{% set active_page = 'autopilot' %}
{% block title %}Autopilot Solar | SolarMind{% endblock %}

{% block content %}
<div class="container-fluid px-4">
<!-- Header Section -->
<div class="text-center mb-5">
  <div class="d-inline-block p-3 rounded-circle mb-3" style="background: linear-gradient(45deg, #FE5800, #00bfff); box-shadow: 0 0 30px rgba(254, 88, 0, 0.3);">
    <i class="fa-solid fa-robot fa-3x text-white"></i>
  </div>
  <h2 class="fw-bold mb-3" style="color: #00bfff; text-shadow: 0 0 10px rgba(0, 191, 255, 0.3);">AUTOPILOT SOLAR</h2>
  <p class="lead text-light">Sistema de Inteligência Artificial para Otimização Energética</p>
  <div class="badge bg-success px-3 py-2" style="font-size: 1rem;">
    <i class="fa-solid fa-microchip me-2"></i>Sistema Ativo
  </div>
</div>

<!-- Métricas Principais -->
<div class="row g-4 mb-4">
  <div class="col-lg-4 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-clock fa-3x mb-3" style="color: #00bfff;"></i>
      <h6 class="text-light mb-1">Janela de Pico</h6>
      <h3 class="fw-bold mb-2" style="color: #00bfff;">{{ plan.peak_window.start }} – {{ plan.peak_window.end }}</h3>
      <small class="text-light">Evite operar cargas intensas nesse período</small>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-6">
    <div class="glass p-4 text-center">
      <i class="fa-solid fa-battery-three-quarters fa-3x mb-3" style="color: #28a745;"></i>
      <h6 class="text-light mb-1">Estado de Carga</h6>
      <h3 class="fw-bold mb-2" style="color: #28a745;">{{ plan.soc }}%</h3>
      <small class="text-light">Previsão: <strong style="color: #ffc107;">{{ plan.forecast_kwh }} kWh</strong></small>
    </div>
  </div>
  
  <div class="col-lg-4 col-md-12">
    <div class="glass p-4">
      <div class="d-flex align-items-center mb-3 flex-wrap">
        <i class="fa-solid fa-microphone fa-lg me-3" style="color: #FE5800;"></i>
        <h6 class="fw-semibold mb-0" style="color: #FE5800;">Comando Alexa</h6>
      </div>
      <div class="alert alert-info mb-3" style="background: rgba(0, 191, 255, 0.1); border: 1px solid rgba(0, 191, 255, 0.3); color: #00bfff;">
        <i class="fa-solid fa-quote-left me-2"></i>
        {{ plan.alexa_message }}
        <i class="fa-solid fa-quote-right ms-2"></i>
      </div>
      <div class="d-grid">
        <button id="announceBtn" class="btn btn-warning btn-lg">
          <i class="fa-solid fa-volume-up me-2"></i>Anunciar na Alexa
        </button>
        <small id="announceStatus" class="text-center mt-2 text-light"></small>
      </div>
      <input type="hidden" id="alexaMsgVal" value="{{ plan.alexa_message | e }}" />
    </div>
  </div>
</div>

<!-- Previsão do Tempo -->
<div class="glass p-4 mb-4">
    <h5 class="fw-semibold mb-4" style="color: #28a745;"><i class="fas fa-cloud-sun-rain me-2"></i>Previsão do Tempo - Próximos 5 Dias</h5>
    <div class="row g-3">
        {% if previsao_tempo %}
            {% for dia in previsao_tempo %}
            <div class="col">
                <div class="card text-center h-100" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="card-body">
                        <h6 class="card-title">{{ dia.data.split(' ')[0] | format_date }}</h6>
                        <img src="{{ obter_icone_url(dia.icone) }}" alt="{{ dia.descricao }}" width="60" height="60">
                        <p class="fw-bold mb-1">{{ "%.1f"|format(dia.temperatura) }}°C</p>
                        <small class="text-light text-capitalize">{{ dia.descricao }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-warning">Não foi possível carregar a previsão do tempo. Usando plano padrão.</div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Recomendações Inteligentes -->
<div class="glass p-4 mb-4">
  <div class="d-flex align-items-center mb-4 flex-wrap">
    <i class="fa-solid fa-lightbulb fa-lg me-3" style="color: #FE5800;"></i>
    <h5 class="fw-semibold mb-0" style="color: #FE5800;">Recomendações Inteligentes</h5>
  </div>
  
  <div class="row g-3">
    {% for rec in plan.recommendations %}
    <div class="col-lg-6 col-md-12">
      <div class="card border-0" style="background: rgba(255, 255, 255, 0.05); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden;">
        <div class="card-body p-3">
          <div class="d-flex align-items-start">
            <i class="fa-solid fa-check-circle text-success me-3 mt-1 flex-shrink-0"></i>
            <p class="text-light mb-0 text-break">{{ rec }}</p>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Cargas Críticas -->
<div class="glass p-4 mb-4">
  <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap">
    <div class="d-flex align-items-center flex-wrap">
      <i class="fa-solid fa-exclamation-triangle fa-lg me-3" style="color: #ffc107;"></i>
      <h5 class="fw-semibold mb-0" style="color: #ffc107;">Cargas Críticas</h5>
    </div>
    <span class="badge bg-warning text-white px-3 py-2 mt-2 mt-md-0" style="background: linear-gradient(45deg, #ffc107, #ff8c00) !important;">Atenção Requerida</span>
  </div>
  
  {% if plan.shed and plan.shed|length > 0 %}
  <div class="row g-3">
    {% for dev in plan.shed %}
    <div class="col-lg-6 col-md-12">
      <div class="card border-0" style="background: rgba(255, 193, 7, 0.1); border-radius: 15px; border: 1px solid rgba(255, 193, 7, 0.3); overflow: hidden;">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <i class="fa-solid fa-bolt text-warning me-3 flex-shrink-0"></i>
            <div class="flex-grow-1 min-w-0">
              <p class="text-light mb-1 fw-semibold text-break">{{ dev }}</p>
              <small class="text-warning">Reduzir consumo durante horário de pico</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5">
    <i class="fa-solid fa-check-circle text-success fa-4x mb-4"></i>
    <h4 class="text-success mb-3">Sistema Totalmente Otimizado</h4>
    <p class="text-light mb-0">Nenhuma carga crítica detectada no momento</p>
  </div>
  {% endif %}
</div>

<!-- Controles do Sistema -->
<div class="glass p-4 text-center">
  <h5 class="fw-semibold mb-4" style="color: #FE5800;">Controles do Sistema</h5>
  <div class="d-flex justify-content-center gap-3 flex-wrap">
    <a href="{{ url_for('dash.autopilot') }}" class="btn btn-outline-info px-4 py-2">
      <i class="fa-solid fa-refresh me-2"></i>Atualizar Plano
    </a>
    <a href="{{ url_for('dash.dashboard') }}" class="btn btn-warning px-4 py-2">
      <i class="fa-solid fa-tachometer-alt me-2"></i>Ver Dashboard
    </a>
  </div>
</div>
</div> <!-- fecha container-fluid -->
{% endblock %}

{% block extra_scripts %}
<script>
  const autopilotMessage = document.getElementById('alexaMsgVal')?.value || '';
  document.getElementById('announceBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('announceBtn');
    const status = document.getElementById('announceStatus');
    btn.disabled = true; status.textContent = 'enviando...';
    try {
      const resp = await fetch('/api/autopilot/announce', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: autopilotMessage })
      });
      const data = await resp.json();
      if (data.status === 'sucesso') {
        status.textContent = 'enviado ✅';
      } else {
        status.textContent = 'erro ❌';
        console.warn('Announce error:', data);
      }
      setTimeout(() => status.textContent = '', 4000);
    } catch (e) {
      status.textContent = 'erro de rede';
      setTimeout(() => status.textContent = '', 4000);
    } finally {
      btn.disabled = false;
    }
  });
</script>
{% endblock %}
